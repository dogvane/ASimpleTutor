# 习题生成与练习反馈

## 1. 考核体系

将评估无缝融入学习流程：
- **Embedded Quiz (随堂测验)**：以 **Quiz Slide** 的形式穿插在 PPT 播放流中，学完即测。
- **Chapter Review (章节考核)**：针对整个章节的综合测试卷（一组连续的 Quiz Slides）。
- **Mistake Review (错题复习)**：针对复习模式生成的专项 Quiz Slide 队列。

## 2. 习题生成策略

### 2.1 题型库
- **单选题 (Single Choice)**：考核概念辨析。
- **判断题 (True/False)**：快速检验核心观点。
- **多选题 (Multiple Choice)**：考核综合理解能力 [计划中]。
- **简答题 (Short Answer)**：考核深入理解能力 [计划中]。
- **填空题 (Fill Blank)**：考核细节记忆能力 [计划中]。

### 2.2 生成流程
1.  **Context 准备**：获取 KP 核心内容 + 原文片段。
2.  **Agent Prompting**：
    - Role: Examiner (严谨的考官)。
    - Task: 生成符合难度要求的题目，并给出标准答案和解析。
    - Output: 结构化 JSON。
3.  **后处理**：处理生成的习题，确保结构正确。

## 3. 交互与反馈 (Embedded Interaction)

### 3.1 Quiz Slide 展示
- 每一个习题渲染为一个独立的 **Slide Card**。
- **界面**：
    - 上半部分：题目描述（支持代码块、图片）。
    - 下半部分：交互选项区域。
    - 底部：提交按钮（对于单选可能点击选项即提交）。

### 3.2 即时判题
- 用户提交后，**不跳转页面**，直接在当前 Slide 上覆盖显示结果层。
    - **Correct**: 显示绿色对勾 ✅ + “回答正确” + 简短解析。
    - **Incorrect**: 显示红色叉号 ❌ + “回答错误” + 错因分析 + 标准答案。
- **流程控制**：
    - 强制模式：必须答对（或尝试 N 次）才能点击“Next”翻到下一页。
    - 宽松模式：答错也可以继续。

### 3.3 掌握度更新 (Mastery Level)
- 每次 Quiz Slide 交互结束后，后台异步更新相关 knowledge point 的掌握度。

### 3.4 错题本 (Mistake Notebook)
- 用户做错的题目自动进入 `MistakeRecord` 表。
- **消灭错题**：用户在错题本中点击“复习”，系统生成一个包含该题的临时 **Quiz Slide**，用户重做正确后将其标记为已解决。

## 4. 数据结构

### 4.1 Exercise Schema
```json
{
  "exerciseId": "string",
  "kpId": "string",
  "type": "SingleChoice|MultipleChoice|TrueFalse|ShortAnswer|FillBlank",
  "difficulty": 1-5,
  "question": "string",
  "options": ["string"],
  "correctAnswer": "string",
  "explanation": "string",
  "hint": "string"
}
```

### 4.2 Exercise Feedback Schema
```json
{
  "exerciseId": "string",
  "kpId": "string",
  "userAnswer": "string",
  "isCorrect": true|false,
  "explanation": "string",
  "referenceAnswer": "string"
}
```

## 5. 核心实现

### 5.1 服务依赖

- **ILLMService**：用于与 LLM 模型交互，生成习题和反馈。
- **KnowledgeSystemStore**：用于加载知识系统数据，获取关联的原文片段。
- **ILogger<ExerciseService>**：用于日志记录。

### 5.2 生成流程

1. **内容准备**：
   - 从 `KnowledgeSystemStore` 加载文档数据，根据 KP 的 `BookHubId` 获取关联的文档列表。
   - 根据 KP 的 `ChapterPath` 和 `DocId` 在文档中定位对应的章节。
   - 从章节的行号范围提取原文片段，拼接成完整的上下文文本。
   - 检查拼接后的文本长度是否足够（至少 100 字符）。

2. **核心生成**：
   - 调用 `LLMService.ChatJsonAsync` 生成习题，包括题目、选项、正确答案和解析。
   - 目前支持的题型：单选题 (SingleChoice) 和判断题 (TrueFalse)。
   - 处理生成的习题，确保结构正确，例如确保单选题只有一个正确答案。

3. **返回结果**：
   - 返回生成的习题列表，每个习题包含 `ExerciseId`、`KpId`、`Type`、`Difficulty`、`Question`、`Options`、`CorrectAnswer`、`Explanation` 等属性。

### 5.3 反馈流程

1. **接收答案**：
   - 接收用户提交的答案。

2. **核心判断**：
   - 对于单选题和判断题，直接进行字符串比较判断是否正确。
   - 对于简答题，调用 `LLMService.ChatJsonAsync` 生成反馈，包括是否正确、解释和参考答案。
   - 处理生成的反馈，确保结构正确。

3. **错题记录**：
   - 如果用户答错，将错题记录到内存缓存中。
   - 提供错题本功能，允许用户查看和复习错题。

4. **掌握度计算**：
   - 根据用户的答题情况，计算掌握度更新。
   - 正确答案会增加掌握度，错误答案会减少掌握度。

5. **返回结果**：
   - 返回生成的反馈，包括是否正确、解释、参考答案、覆盖的要点和遗漏的要点等属性。

