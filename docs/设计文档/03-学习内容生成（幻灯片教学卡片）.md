# 学习内容生成（幻灯片教学卡片）

## 1. 核心理念

基于章节片段原文、知识点信息、知识图谱生成合适的口语化教案，以幻灯片形式呈现。每个知识点生成一组有序的幻灯片卡片，内容分为多个部分逐个生成。

## 2. 幻灯片卡片结构 (Slide Structure)

每个章节生成一组有序的幻灯片卡片，通常包含多个页面。

### 2.1 PPT页面类型

| 类型 | 目标 | 包含元素 |
| :--- | :--- | :--- |
| **封面/介绍** | 建立章节概念认知 | 大标题、一句话定义、核心要点 (Bullet points) |
| **内容讲解** | 深入理解原理与机制 | 详细阐述、图表、代码块、原文对照 |
| **深入分析** | (可选) 融会贯通 | 边界条件、与相关概念的对比、最佳实践 |
| **知识关联** | 知识关联 | 与其他知识点的关联，基于知识图谱的语义关系 |
| **总结回顾** | 总结回顾 | 要点回顾、应用场景 |
| **习题页** | 练习巩固 | 习题按钮，位于右下角 |

### 2.2 内容生成策略

- **数据源**：章节片段原文、知识点信息、知识图谱。
- **生成方式**：内容在生成阶段由 Agent 逐个生成并缓存，**非浏览时实时生成**（以保证流畅性）。
- **口语化教案**：基于教学内容生成合适的口语化讲解，便于理解和学习。

## 3. PPT内容与口播说明

### 3.1 PPT内容生成

- **基于片段原文**：幻灯片内容基于章节片段原文，确保内容的准确性和完整性。
- **知识点信息**：融入知识点信息，增强教学的针对性和深度。
- **知识图谱**：基于知识图谱展示知识点间的关联，帮助用户理解知识体系。

### 3.2 TTS口播说明生成

- **口语化教案**：为每个幻灯片页面生成匹配的口语化教案。
- **TTS对接**：口播说明用于对接TTS（文本转语音）功能，提供音频讲解。
- **生成策略**：在生成幻灯片内容的同时，生成对应的口播说明文本。

## 4. 交互方式

### 4.1 滑动翻页

- **鼠标滚轮**：支持鼠标滚轮进行上下/左右翻页。
- **点击翻页**：支持点击按钮进行翻页。

### 4.2 原文对照

- **位置信息**：在关键内容处，可查看对应的原文片段。
- **详细信息**：包含filePath + 标题路径 + 行号范围。

### 4.3 知识关联

- **链接跳转**：内容中提及其他知识点时，提供可点击链接。
- **跳转功能**：点击后跳转到相关内容。

## 5. 习题功能

### 5.1 习题位置

- **右下角按钮**：习题按钮位于最后一页PPT的右下角。

### 5.2 交互方式

- **展开界面**：点击习题按钮后，在当前PPT位置展开习题界面。
- **复习总结**：用户可进行复习和总结。
- **继续学习**：完成习题后，可选择继续学习下一章。

### 5.3 习题类型

- **选择题**：单选题或多选题。
- **填空题**：填入正确答案。
- **简答题**：简要回答问题。

### 5.4 习题反馈

- **即时反馈**：用户作答后，输出反馈与参考答案/要点。
- **错误分析**：分析错误原因，帮助用户理解。

## 6. Agent 角色设定 (System Prompt)

- **Role**: 资深技术导师 (Technical Tutor)。
- **Tone**: 口语化、亲切、逻辑清晰（适合教学讲解）。
- **Output Format**: 生成结构化的 JSON 数据，包含每一页的 html_content, speech_script, source_references。

## 7. 缓存与更新

- **全量缓存**：生成的 Slide JSON 和 TTS 脚本均持久化存储。
- **Invalidation**：源文档变更导致章节哈希改变时，标记缓存失效，需重新触发生成流程。

## 8. 核心实现

### 8.1 服务依赖

- **DataStore**：用于加载预处理数据，获取片段及其位置信息。
- **ILLMService**：用于与 LLM 模型交互，生成学习内容。
- **IKnowledgeGraphBuilder**：用于获取知识点的知识图谱关联信息。
- **ILogger**：用于日志记录。

### 8.2 生成流程

1. **内容准备**：
   - 从 `DataStore` 加载预处理数据，获取章节树和片段。
   - 根据章节选择对应的片段，提取原文片段。
   - 检查文本长度是否足够（至少 100 字符）。

2. **知识图谱关联准备**：
   - 调用 `IKnowledgeGraphBuilder` 获取当前章节的知识图谱关联信息。
   - 获取关联的知识点和关系类型，包括包含、依赖、相关、对比等。

3. **核心生成**：
   - 调用 `LLMService.ChatJsonAsync` 生成学习内容，包括PPT内容和口播说明。
   - 生成的内容结构包括：
     - `ppt_pages`：包含多个PPT页面，每个页面包含 `htmlContent` 和 `speechScript`。
     - `knowledge_graph_relations`：包含当前章节的知识图谱关联信息。

4. **后处理与增强**：
   - 将生成的 DTO 转换为领域模型，如 `ChapterLearningPack` 和 `SlideCard`。
   - 为幻灯片卡片添加原文引用信息，包括文件路径、章节路径、行号范围等。
   - 为幻灯片卡片添加知识图谱关联信息。

5. **降级策略**：
   - 如果输入文本长度不足或生成失败，使用 `CreateFallbackLearningPack` 方法生成简化版学习内容。
   - 从原文片段中提取要点，填充基本信息。

### 8.3 输出数据结构

**章节学习包 (Chapter Learning Pack)**：

```json
{
  "chapterId": "chapter_001",
  "title": "章节标题",
  "pptPages": [
    {
      "pageId": "page_001",
      "chapterId": "chapter_001",
      "type": "cover",
      "order": 0,
      "title": "页面标题",
      "htmlContent": "幻灯片内容，HTML 格式",
      "speechScript": "口播说明文本，用于 TTS",
      "sourceReferences": [
        {
          "filePath": "path/to/file.md",
          "chapterPath": "第一章 > 第一节",
          "lineRange": "10-20"
        }
      ],
      "knowledgeGraphData": {
        "relatedPoints": [
          {
            "pointId": "point_002",
            "title": "关联知识点",
            "relationship": "依赖",
            "weight": 0.8
          }
        ]
      }
    }
  ],
  "exercise": {
    "exerciseId": "exercise_001",
    "chapterId": "chapter_001",
    "type": "choice",
    "question": "题目内容",
    "options": ["选项A", "选项B", "选项C", "选项D"],
    "correctAnswer": "A",
    "explanation": "答案解析"
  }
}
```
