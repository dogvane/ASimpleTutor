# 学习内容生成（幻灯片教学卡片）

## 1. 核心理念

模拟一位经验丰富的导师，根据用户的学习需求，生成一组结构化的**HTML 教学卡片 (Slide Cards)**。内容不是静态文本堆砌，而是流式的、强交互的阅读体验。

## 2. 幻灯片卡片结构 (Slide Structure)

每个知识点 (Concept KP) 生成一组有序的 Slides，通常包含 3-5 张卡片。
当用户选择父级章节时，系统将该章节下所有 KP 的 Slides 串联成一个长播放列表 (Playlist)。

### 2.1 Slide 类型定义

| 类型 | 对应原 Level | 目标 | 包含元素 |
| :--- | :--- | :--- | :--- |
| **Cover / Intro** | L1 (Glance) | 10秒内建立概念认知 | 大标题、一句话定义、核心要点 (Bullet points) |
| **Explanation** | L2 (Detail) | 深入理解原理与机制 | 详细阐述、图表、代码块、原文悬停点 |
| **Deep Dive** | L3 (Deep) | (可选) 融会贯通 | 边界条件、与相关概念的对比、最佳实践 |
| **Source** | Source | 查看原文 | 原文片段、引用 |
| **Quiz** | Quiz | 即时检验 | 单选题/判断题，交互式反馈 |
| **Relations** | Relations | 知识关联 | 与其他知识点的关联 |
| **Summary** | Summary | 总结回顾 | 要点回顾、应用场景 |

### 2.2 内容生成策略

- **数据源**：KP 关联的静态 Snippets。
- **动态性**：内容在预处理/生成阶段由 Agent 批量生成并缓存，**非浏览时实时生成**（以保证流畅性）。

## 3. 交互式原文索引 (Interactive Source Indexing) [计划中]

### 3.1 原文悬停 (Hover-over Source)
- **机制**：Agent 在生成解释性文本时，会识别出依据原文的关键陈述。
- **标记**：在前端渲染时，这些文本下方显示虚线或高亮。
- **交互**：鼠标悬停（Hover）在标记上时，浮层展示对应的原始文档片段（Markdown 原文 + 来源文件路径）。
- **目的**：提供证据链，消除幻觉，且不打断沉浸式阅读。

### 3.2 知识跳跃 (Hyperlink Jumping)
- **机制**：识别文本中提到的其他已录入系统的知识点名称。
- **交互**：自动转换为内部链接，点击后跳转到目标知识点的 Cover Slide。

## 4. 音频资源管理 (Audio Resources) [计划中]

为增强导学体验，系统计划支持为每一页 Slide 关联一段语音讲解。

### 4.1 预生成策略 (Pre-generation)
- **时机**：在 Agent 生成 Slide HTML 内容的同时，或者作为独立的后处理任务。
- **输入**：该页 Slide 的讲解脚本 (Script)。Agent 除了生成显示的 Text，还会生成一段口语化的 speech_text。
- **处理**：调用 TTS 引擎将 speech_text 转换为 .mp3 文件。
- **存储**：保存至本地资源目录，文件命名规则如 {kp_id}_slide_{index}.mp3。

### 4.2 播放逻辑
- 用户浏览时，前端检查当前 Slide 是否存在对应的音频文件。
- 若存在，启用播放按钮；若开启自动播放，则翻页即播。
- **不支持及时的实时 TTS**，以确保响应速度和离线可用性。

## 5. Agent 角色设定 (System Prompt)

- **Role**: 资深技术导师 (Technical Tutor)。
- **Tone**: 口语化、亲切、逻辑清晰（适合幻灯片演讲）。
- **Output Format**: 生成结构化的 JSON 数据，包含每一页的 html_content, speech_script, source_references。

## 6. 缓存与更新

- **全量缓存**：生成的 Slide JSON 和 MP3 文件均持久化存储。
- **Invalidation**：源文档变更导致 KP 哈希改变时，标记缓存失效，需重新触发生成流程。

## 7. 核心实现

### 7.1 服务依赖

- **KnowledgeSystemStore**：用于加载知识系统数据，获取关联的原文片段。
- **ILLMService**：用于与 LLM 模型交互，生成学习内容。
- **ILogger<LearningGenerator>**：用于日志记录。

### 7.2 生成流程

1. **内容准备**：
   - 从 `KnowledgeSystemStore` 加载知识系统，根据 KP 的 `SnippetIds` 获取关联的原文片段。
   - 拼接原文片段，检查长度是否足够（至少 100 字符）。

2. **核心生成**：
   - 调用 `LLMService.ChatJsonAsync` 生成学习内容，包括摘要、层次化内容和幻灯片卡片。
   - 生成的内容结构包括：
     - `summary`：包含定义、核心要点和常见误区。
     - `levels`：包含层次化内容，如概览、详细、深入。
     - `slide_cards`：包含多种类型的幻灯片卡片。

3. **后处理与增强**：
   - 将生成的 DTO 转换为领域模型，如 `LearningPack` 和 `SlideCard`。
   - 转换幻灯片卡片类型，确保与系统定义的类型一致。

4. **降级策略**：
   - 如果输入文本长度不足或生成失败，使用 `CreateFallbackLearningPack` 方法生成简化版学习内容。
   - 从原文片段中提取要点，填充基本信息。

### 7.3 输出数据结构

**学习包 (Learning Pack)**：

```json
{
  "kpId": "kp_001",
  "summary": {
    "definition": "知识点的精确定义",
    "keyPoints": ["核心要点1", "核心要点2", "核心要点3"],
    "pitfalls": ["常见误区1", "常见误区2"]
  },
  "levels": [
    {
      "level": 1,
      "title": "概览",
      "content": "面向第一次接触的简要介绍"
    },
    {
      "level": 2,
      "title": "详细",
      "content": "解释关键机制、步骤、例子"
    },
    {
      "level": 3,
      "title": "深入",
      "content": "边界条件、对比、推导"
    }
  ],
  "slideCards": [
    {
      "slideId": "slide_001",
      "kpId": "kp_001",
      "type": "cover",
      "order": 0,
      "title": "卡片标题",
      "htmlContent": "幻灯片内容，HTML 格式",
      "sourceReferences": [],
      "config": {
        "allowSkip": true,
        "requireComplete": false
      }
    }
  ],
  "snippetIds": ["snippet_001", "snippet_002"],
  "relatedKpIds": []
}
```
