# 数据模型与存储策略

## 1. 存储架构

采用 **分层存储** 方案，将不同类型的数据存储在不同的位置，以满足不同阶段的需求。

### 1.1 存储方案

- **预处理数据**：存储为单独的文件，包含章节树、片段（Section）及其位置信息。
- **知识产品数据**：
  - 知识点、知识体系、知识图谱存储在本地数据库（SQLite）。
  - PPT内容和TTS口播说明存储为文件或数据库记录，与片段关联。
- **向量数据**：嵌入式向量数据库（或 SQLite 向量扩展），用于 RAG 检索。

### 1.2 存储结构

```
saves/
  ├── {BookId}/
  │   ├── pre-processing.json        # 预处理数据（章节树、片段）
  │   ├── knowledge-points.db        # 知识点、知识体系、知识图谱（SQLite）
  │   ├── ppt-content/               # PPT内容文件
  │   │   ├── chapter_001.json
  │   │   └── chapter_002.json
  │   └── tts-scripts/               # TTS口播说明文件
  │       ├── chapter_001.txt
  │       └── chapter_002.txt
```

## 2. 数据模型

### 2.1 预处理数据 (PreProcessingData)

```json
{
  "BookId": "string",
  "ScanTime": "datetime",
  "ChapterTree": {
    "Id": "string",
    "Title": "string",
    "HeadingPath": ["string"],
    "FilePath": "string",
    "Children": [
      {
        "Id": "string",
        "Title": "string",
        "HeadingPath": ["string"],
        "FilePath": "string",
        "Children": []
      }
    ]
  },
  "Sections": [
    {
      "SectionId": "string",
      "ChapterId": "string",
      "FilePath": "string",
      "ChapterPath": ["string"],
      "LineRange": {
        "Start": 0,
        "End": 0
      },
      "Content": "string"
    }
  ]
}
```

### 2.2 知识点 (KnowledgePoint)

```json
{
  "KpId": "string",
  "BookId": "string",
  "SectionId": "string",
  "Title": "string",
  "Type": "concept|chapter|process|api|bestPractice",
  "Importance": 0.0-1.0,
  "ChapterPath": ["string"],
  "Relationships": [
    {
      "TargetKpId": "string",
      "Type": "parent|child|related|depends|contrast",
      "Weight": 0.0-1.0
    }
  ]
}
```

### 2.3 知识图谱节点 (KnowledgeGraphNode)

```json
{
  "NodeId": "string",
  "KpId": "string",
  "Type": "concept|chapter|process|api|bestPractice",
  "Importance": 0.0-1.0,
  "ChapterPath": ["string"],
  "Position": {
    "X": 0.0,
    "Y": 0.0
  },
  "Size": 1.0,
  "Color": "string"
}
```

### 2.4 知识图谱边 (KnowledgeGraphEdge)

```json
{
  "EdgeId": "string",
  "SourceNodeId": "string",
  "TargetNodeId": "string",
  "Type": "parent|child|related|depends|contrast",
  "Weight": 0.0-1.0,
  "Label": "string"
}
```

### 2.5 PPT内容 (PPTContent)

```json
{
  "ChapterId": "string",
  "BookId": "string",
  "Title": "string",
  "Pages": [
    {
      "PageId": "string",
      "Type": "cover|content|deep|relations|summary",
      "Order": 0,
      "Title": "string",
      "HtmlContent": "string",
      "SourceReferences": [
        {
          "FilePath": "string",
          "ChapterPath": ["string"],
          "LineRange": {
            "Start": 0,
            "End": 0
          }
        }
      ],
      "KnowledgeGraphData": {
        "RelatedPoints": [
          {
            "KpId": "string",
            "Title": "string",
            "Relationship": "string",
            "Weight": 0.0-1.0
          }
        ]
      }
    }
  ],
  "Exercise": {
    "ExerciseId": "string",
    "ChapterId": "string",
    "Type": "choice|fill|short",
    "Question": "string",
    "Options": ["string"],
    "CorrectAnswer": "string",
    "Explanation": "string"
  }
}
```

### 2.6 TTS口播说明 (TTSScript)

```json
{
  "ChapterId": "string",
  "BookId": "string",
  "Scripts": [
    {
      "PageId": "string",
      "SpeechScript": "string",
      "Duration": 0.0
    }
  ]
}
```

## 3. 核心实现

### 3.1 数据存储服务

#### 预处理数据存储服务 (PreProcessingDataStore)

- 负责预处理数据的持久化存储和加载。
- 支持单独的文件存储，方便后续使用。

#### 知识产品数据存储服务 (KnowledgeProductStore)

- 负责知识点、知识体系、知识图谱的存储（SQLite）。
- 负责 PPT内容和TTS口播说明的存储（文件或数据库）。

#### 向量数据存储服务 (VectorStore)

- 负责向量数据的存储和检索。
- 支持 RAG 检索。

### 3.2 数据保存与加载流程

**保存流程**：

1. **预处理阶段**：
   - 创建保存目录：`saves/{BookId}`。
   - 保存预处理数据：`saves/{BookId}/pre-processing.json`。

2. **数据生成阶段**：
   - 保存知识点、知识体系、知识图谱到 SQLite 数据库。
   - 保存 PPT内容到文件：`saves/{BookId}/ppt-content/chapter_*.json`。
   - 保存 TTS口播说明到文件：`saves/{BookId}/tts-scripts/chapter_*.txt`。

**加载流程**：

1. **预处理数据加载**：
   - 检查保存目录是否存在：`saves/{BookId}`。
   - 加载预处理数据：`saves/{BookId}/pre-processing.json`。

2. **知识产品数据加载**：
   - 从 SQLite 数据库加载知识点、知识体系、知识图谱。
   - 从文件加载 PPT内容：`saves/{BookId}/ppt-content/chapter_*.json`。
   - 从文件加载 TTS口播说明：`saves/{BookId}/tts-scripts/chapter_*.txt`。

## 4. 数据关联

所有数据都与片段（Section）直接关联：

- **知识点**：关联到对应的片段。
- **知识体系**：基于片段和知识点构建。
- **知识图谱**：基于知识点构建，节点和边都关联到知识点。
- **PPT内容**：基于片段、知识点信息和知识点关系生成。
- **TTS口播说明**：基于PPT内容生成，与PPT页面关联。

## 5. 未来扩展

- **支持 SQLite 扩展**：添加更多索引和查询优化。
- **支持向量存储**：添加向量存储和语义检索功能。
- **支持多书籍**：添加书籍切换和管理功能。