# 数据模型与存储策略

## 1. 存储架构

采用 **文件系统存储** 方案，将知识系统数据以 JSON 格式存储在本地文件系统中。

### 1.1 为什么选择文件系统存储?
- **部署简单**：无需单独安装数据库服务，文件即数据。
- **易于理解**：JSON 格式易于阅读和调试。
- **性能足够**：对于单用户/本地应用，文件系统存储性能足够。

### 1.2 存储结构

```
saves/
  ├── {BookHubId}/
  │   ├── knowledge-system.json      # 知识系统数据
  │   ├── snippets.json              # 原文片段数据
  │   └── documents.json             # 文档章节信息
```

## 2. 数据模型

### 2.1 KnowledgeSystem

```json
{
  "BookHubId": "string",
  "KnowledgePoints": [
    {
      "KpId": "string",
      "BookHubId": "string",
      "Title": "string",
      "Type": "concept|chapter|process|api|bestPractice",
      "Importance": 0.0-1.0,
      "SnippetIds": ["string"],
      "ChapterPath": ["string"],
      "Summary": {
        "Definition": "string",
        "KeyPoints": ["string"],
        "Pitfalls": ["string"]
      },
      "Levels": [
        {
          "Level": 1,
          "Title": "string",
          "Content": "string"
        }
      ],
      "SlideCards": [
        {
          "SlideId": "string",
          "KpId": "string",
          "Type": "Cover|Explanation|DeepDive|Source|Quiz|Relations|Summary",
          "Order": 0,
          "Title": "string",
          "HtmlContent": "string",
          "SourceReferences": [],
          "Config": {
            "AllowSkip": true,
            "RequireComplete": false
          }
        }
      ]
    }
  ],
  "Snippets": {
    "string": {
      "SnippetId": "string",
      "BookHubId": "string",
      "DocId": "string",
      "FilePath": "string",
      "HeadingPath": ["string"],
      "Content": "string",
      "StartLine": 0,
      "EndLine": 0,
      "ChunkId": "string"
    }
  },
  "Tree": {
    "Id": "string",
    "Title": "string",
    "HeadingPath": ["string"],
    "Children": [
      {
        "Id": "string",
        "Title": "string",
        "HeadingPath": ["string"],
        "Children": [],
        "KnowledgePoint": {
          "KpId": "string",
          "Title": "string",
          ...
        }
      }
    ]
  }
}
```

### 2.2 Document

```json
{
  "DocumentId": "string",
  "FilePath": "string",
  "Title": "string",
  "Chapters": [
    {
      "Title": "string",
      "Content": "string",
      "StartLine": 0,
      "EndLine": 0,
      "SubChapters": []
    }
  ],
  "Snippets": [
    {
      "SnippetId": "string",
      "Content": "string",
      "StartLine": 0,
      "EndLine": 0
    }
  ]
}
```

### 2.3 KnowledgePoint

```json
{
  "KpId": "string",
  "Title": "string",
  "Type": "Concept|Chapter|Process",
  "Importance": 1-5,
  "SnippetIds": ["string"],
  "ChapterPath": ["string"]
}
```

### 2.4 SourceSnippet

```json
{
  "SnippetId": "string",
  "Content": "string",
  "FilePath": "string",
  "StartLine": 0,
  "EndLine": 0
}
```

### 2.5 LearningPack

```json
{
  "KpId": "string",
  "Summary": {
    "Definition": "string",
    "KeyPoints": ["string"],
    "Pitfalls": ["string"]
  },
  "Levels": [
    {
      "Level": 1,
      "Title": "string",
      "Content": "string"
    }
  ],
  "SlideCards": [
    {
      "SlideId": "string",
      "KpId": "string",
      "Type": "Cover|Explanation|DeepDive|Source|Quiz|Relations|Summary",
      "Order": 0,
      "Title": "string",
      "HtmlContent": "string",
      "SourceReferences": [],
      "Config": {
        "AllowSkip": true,
        "RequireComplete": false
      }
    }
  ],
  "SnippetIds": ["string"],
  "RelatedKpIds": ["string"]
}
```

### 2.6 Exercise

```json
{
  "ExerciseId": "string",
  "KpId": "string",
  "Type": "SingleChoice|MultipleChoice|TrueFalse|ShortAnswer|FillBlank",
  "Difficulty": 1-5,
  "Question": "string",
  "Options": ["string"],
  "CorrectAnswer": "string",
  "Explanation": "string",
  "Hint": "string"
}
```

### 2.7 ExerciseFeedback

```json
{
  "ExerciseId": "string",
  "KpId": "string",
  "UserAnswer": "string",
  "IsCorrect": true|false,
  "Explanation": "string",
  "ReferenceAnswer": "string"
}
```

## 3. 核心实现

### 3.1 KnowledgeSystemStore

`KnowledgeSystemStore` 负责知识系统的持久化存储和加载：

- **构造函数**：`public KnowledgeSystemStore(ILogger<KnowledgeSystemStore> logger, string baseDataDirectory)`
- **SaveAsync**：将知识系统保存到文件系统。
- **LoadAsync**：从文件系统加载知识系统。
- **Save**：同步保存知识系统到文件系统。
- **Load**：同步从文件系统加载知识系统。

### 3.2 数据加载与保存流程

1. **保存流程**：
   - 创建保存目录：`saves/{BookHubId}`。
   - 并行保存知识体系、原文片段和文档章节信息：
     - 知识体系：`saves/{BookHubId}/knowledge-system.json`
     - 原文片段：`saves/{BookHubId}/snippets.json`
     - 文档章节信息：`saves/{BookHubId}/documents.json`

2. **加载流程**：
   - 检查保存目录是否存在：`saves/{BookHubId}`。
   - 并行加载知识体系、原文片段和文档章节信息：
     - 知识体系：`saves/{BookHubId}/knowledge-system.json`
     - 原文片段：`saves/{BookHubId}/snippets.json`
     - 文档章节信息：`saves/{BookHubId}/documents.json`
   - 合并原文片段到知识系统。
   - 重建知识树：使用 `KnowledgeBuilder.BuildKnowledgeTree` 方法。


## 4. 未来扩展

- **支持 SQLite**：未来可以考虑添加 SQLite 存储选项，以支持更复杂的查询和索引。
- **支持向量存储**：未来可以考虑添加向量存储，以支持语义检索。