# 数据模型与存储策略

## 1. 存储架构

采用 **Repository 模式** + **SQLite (Hybrid)** 方案。
单文件 `tutor.db` 存储所有结构化数据，通过 SQLite 扩展（如 `sqlite-vss` 或应用层集成 Qdrant/Chroma）支持向量检索。

### 1.1 为什么选择 SQLite + Extension?
- **部署简单**：无需单独安装数据库服务，文件即数据库。
- **一致性**：关系数据与向量数据在同一事务上下文中。
- **性能**：对于单用户/本地应用，SQLite 性能足够，且支持并发读取。

## 2. 数据库设计 (Schema)

### 2.1 基础表

#### `books` (书籍配置)
| Field | Type | Desc |
|---|---|---|
| id | TEXT PK | UUID |
| name | TEXT | 书籍名称 |
| root_path | TEXT | 根目录绝对路径 |
| config_json | TEXT | 排除规则、参考目录等配置 |
| last_scan_time | DATETIME | 上次扫描时间 |

#### `documents` (文档索引)
| Field | Type | Desc |
|---|---|---|
| id | TEXT PK | UUID |
| book_id | TEXT FK | 关联 books |
| rel_path | TEXT | 相对路径 |
| hash | TEXT | 文件内容 Hash (MD5) |
| type | TEXT | MAIN | REF |
| metadata | TEXT | JSON (Title, Headers) |

#### `chunks` (文本切片 - RAG 核心)
| Field | Type | Desc |
|---|---|---|
| id | TEXT PK | UUID |
| doc_id | TEXT FK | 关联 documents |
| content | TEXT | 切片文本 |
| embedding | BLOB/VECTOR | 向量数据 (Dimensions=1536 for ADA-002) |
| start_line | INT | |
| end_line | INT | |

### 2.2 知识图谱表

#### `knowledge_points` (知识点)
| Field | Type | Desc |
|---|---|---|
| id | TEXT PK | UUID |
| book_id | TEXT FK | |
| doc_id | TEXT FK | 来源文档 |
| title | TEXT | 知识点标题 |
| type | TEXT | CONCEPT | CHAPTER | PROCESS |
| summary | TEXT | 简要描述 |
| parent_id | TEXT FK | 章节父节点 |
| chapter_path | TEXT | JSON 数组，用于快速构建树 |

#### `kp_relations` (关联关系)
| Field | Type | Desc |
|---|---|---|
| from_kp_id | TEXT | |
| to_kp_id | TEXT | |
| relation_type | TEXT | PREREQUISITE | RELATED | CONTRAST |
| description | TEXT | 关系描述 |

#### `kp_chunks` (KP 与原文映射)
| Field | Type | Desc |
|---|---|---|
| kp_id | TEXT | |
| chunk_id | TEXT | |
| role | TEXT | RIMARY | SECONDARY |

### 2.3 学习业务表

#### `learn_content_cache` (生成内容缓存)
| Field | Type | Desc |
|---|---|---|
| kp_id | TEXT PK | |
| level | INT | 1, 2, 3 |
| content_json | TEXT | 生成的结构化内容 |
| version_hash | TEXT | 关联的源文件 Hash 组合 |

#### `exercises` (题库)
| Field | Type | Desc |
|---|---|---|
| id | TEXT PK | |
| kp_id | TEXT FK | |
| content_json | TEXT | 题目完整内容 |
| difficulty | INT | |

#### `user_progress` (用户进度)
| Field | Type | Desc |
|---|---|---|
| kp_id | TEXT PK | |
| status | TEXT | TODO | LEARNING | MASTERED |
| mastery_level | REAL | 0.0 ~ 1.0 |
| last_review_time | DATETIME | |

#### `mistake_records` (错题本)
| Field | Type | Desc |
|---|---|---|
| id | TEXT PK | |
| exercise_id | TEXT FK | |
| user_answer | TEXT | |
| error_analysis | TEXT | |
| create_time | DATETIME | |
| is_resolved | BOOL | |

## 3. 面向接口编程 (Repository)

代码层定义接口，屏蔽实现细节：
- `IBookRepository`: Manage Books.
- `IKnowledgeGraphRepository`: CRUD KPs, Relations.
- `IVectorStore`: Search similarity.
- `IAssessmentRepository`: Manage Exercises, Progress.

## 4. 迁移策略
从 MVP 的 JSON 文件迁移到 SQLite，需提供 `MigrationService`，在首次启动时将 JSON 数据导入 DB。
```