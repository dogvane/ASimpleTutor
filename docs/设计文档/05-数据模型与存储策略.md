# 数据模型与存储策略

## 1. 存储架构

采用 **文件系统存储** 方案，将知识系统数据以 JSON 格式存储在本地文件系统中。

### 1.1 为什么选择文件系统存储?
- **部署简单**：无需单独安装数据库服务，文件即数据。
- **易于理解**：JSON 格式易于阅读和调试。
- **性能足够**：对于单用户/本地应用，文件系统存储性能足够。

### 1.2 存储结构

```
saves/
  ├── {BookHubId}/
  │   ├── knowledge-system.json      # 知识系统数据
  │   ├── snippets.json              # 原文片段数据
  │   └── documents.json             # 文档章节信息
```

## 2. 数据模型

### 2.1 KnowledgeSystem

```json
{
  "BookHubId": "string",
  "KnowledgePoints": [
    {
      "KpId": "string",
      "BookHubId": "string",
      "DocId": "string",
      "Title": "string",
      "Type": "concept|chapter|process|api|bestPractice",
      "Importance": 0.0-1.0,
      "ChapterPath": ["string"],
      "Summary": {
        "Definition": "string",
        "KeyPoints": ["string"],
        "Pitfalls": ["string"]
      },
      "Levels": [
        {
          "Level": 1,
          "Title": "string",
          "Content": "string"
        }
      ],
      "SlideCards": [
        {
          "SlideId": "string",
          "KpId": "string",
          "Type": "Cover|Explanation|DeepDive|Source|Quiz|Relations|Summary",
          "Order": 0,
          "Title": "string",
          "HtmlContent": "string",
          "SpeechScript": "string",
          "SourceReferences": [],
          "Config": {
            "AllowSkip": true,
            "RequireComplete": false
          }
        }
      ]
    }
  ],
  "Documents": [
    {
      "DocId": "string",
      "BookHubId": "string",
      "Path": "string",
      "Title": "string",
      "Sections": [],
      "ContentHash": "string"
    }
  ],
  "Tree": {
    "Id": "string",
    "Title": "string",
    "HeadingPath": ["string"],
    "Children": [
      {
        "Id": "string",
        "Title": "string",
        "HeadingPath": ["string"],
        "Children": [],
        "KnowledgePoint": {
          "KpId": "string",
          "Title": "string",
          ...
        }
      }
    ]
  }
}
```

### 2.2 Document

```json
{
  "DocId": "string",
  "BookHubId": "string",
  "Path": "string",
  "Title": "string",
  "Sections": [
    {
      "SectionId": "string",
      "HeadingPath": ["string"],
      "SubSections": [],
      "StartLine": 0,
      "EndLine": 0,
      "OriginalLength": 0,
      "EffectiveLength": 0,
      "FilteredLength": 0,
      "IsExcluded": false
    }
  ],
  "ContentHash": "string"
}
```

**字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| DocId | string | 文档唯一标识符 |
| BookHubId | string | 书籍中心 ID |
| Path | string | 文档的本地文件系统完整路径 |
| Title | string | 文档标题（通常从 H1 标题提取） |
| Sections | List&lt;Section&gt; | 文档章节列表 |
| ContentHash | string? | 文档内容的 SHA256 哈希值，用于检测变更 |

**Section 字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| SectionId | string | 章节唯一标识符 |
| HeadingPath | List&lt;string&gt; | 标题路径（从根标题到当前章节的层级路径） |
| SubSections | List&lt;Section&gt; | 子章节列表（层级结构） |
| StartLine | int | 章节开始的行号（包含标题行） |
| EndLine | int | 章节结束的行号（不包含） |
| OriginalLength | int | 原始字符数（包含所有内容，包括代码块和HTML标签） |
| EffectiveLength | int | 有效字符数（过滤后，排除代码块和HTML标签） |
| FilteredLength | int | 过滤掉的字符数（原始字符数 - 有效字符数） |
| IsExcluded | bool | 是否被排除（不参与后续处理） |

### 2.3 KnowledgePoint

```json
{
  "KpId": "string",
  "BookHubId": "string",
  "DocId": "string",
  "Title": "string",
  "Type": "Concept|Chapter|Process",
  "Importance": 1-5,
  "ChapterPath": ["string"]
}
```

### 2.4 LearningPack

```json
{
  "KpId": "string",
  "Summary": {
    "Definition": "string",
    "KeyPoints": ["string"],
    "Pitfalls": ["string"]
  },
  "Levels": [
    {
      "Level": 1,
      "Title": "string",
      "Content": "string"
    }
  ],
  "SlideCards": [
        {
          "SlideId": "string",
          "KpId": "string",
          "Type": "Cover|Explanation|DeepDive|Source|Quiz|Relations|Summary",
          "Order": 0,
          "Title": "string",
          "HtmlContent": "string",
          "SpeechScript": "string",
          "SourceReferences": [],
          "Config": {
            "AllowSkip": true,
            "RequireComplete": false
          }
        }
      ],
  "RelatedKpIds": ["string"]
}
```

### 2.5 Exercise

```json
{
  "ExerciseId": "string",
  "KpId": "string",
  "Type": "SingleChoice|MultipleChoice|TrueFalse|ShortAnswer|FillBlank",
  "Difficulty": 1-5,
  "Question": "string",
  "Options": ["string"],
  "CorrectAnswer": "string",
  "Explanation": "string",
  "Hint": "string"
}
```

### 2.6 ExerciseFeedback

```json
{
  "ExerciseId": "string",
  "KpId": "string",
  "UserAnswer": "string",
  "IsCorrect": true|false,
  "Explanation": "string",
  "ReferenceAnswer": "string"
}
```

## 3. 核心实现

### 3.1 KnowledgeSystemStore

`KnowledgeSystemStore` 负责知识系统的持久化存储和加载：

- **构造函数**：`public KnowledgeSystemStore(ILogger<KnowledgeSystemStore> logger, string baseDataDirectory)`
- **SaveAsync**：将知识系统保存到文件系统。
- **LoadAsync**：从文件系统加载知识系统。
- **Save**：同步保存知识系统到文件系统。
- **Load**：同步从文件系统加载知识系统。

### 3.2 数据加载与保存流程

1. **保存流程**：
   - 创建保存目录：`saves/{BookHubId}`。
   - 并行保存知识体系、原文片段和文档章节信息：
     - 知识体系：`saves/{BookHubId}/knowledge-system.json`
     - 原文片段：`saves/{BookHubId}/snippets.json`
     - 文档章节信息：`saves/{BookHubId}/documents.json`

2. **加载流程**：
   - 检查保存目录是否存在：`saves/{BookHubId}`。
   - 并行加载知识体系、原文片段和文档章节信息：
     - 知识体系：`saves/{BookHubId}/knowledge-system.json`
     - 原文片段：`saves/{BookHubId}/snippets.json`
     - 文档章节信息：`saves/{BookHubId}/documents.json`
   - 合并原文片段到知识系统。
   - 重建知识树：使用 `KnowledgeBuilder.BuildKnowledgeTree` 方法。


## 4. 未来扩展

- **支持 SQLite**：未来可以考虑添加 SQLite 存储选项，以支持更复杂的查询和索引。
- **支持向量存储**：未来可以考虑添加向量存储，以支持语义检索。