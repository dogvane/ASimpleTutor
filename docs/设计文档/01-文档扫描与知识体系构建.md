# 文档扫描与知识体系构建（MVP）

## 1. 输入与输出

### 输入

- `book_root_id`：当前激活的书籍目录 ID
- `root_path`：书籍目录路径（来自 `book_root_id` 对应配置项）
- 目录下的一组 `.md` 文档

### 输出

- `KnowledgeSystem`
  - 知识点列表（含层级、关联、重要性）
  - 每个知识点的证据片段引用（用于原文对照）

## 2. 扫描与预处理

### 2.1 文件发现

- 递归或非递归：MVP 建议**递归**（遇到子目录继续扫描），但在配置中可开关。
- 过滤规则：仅 `.md`；忽略隐藏文件、临时文件。

#### 2.1.1 参考书目目录排除（重要）

一个 Book Root 内允许存在“参考书目目录”（同样是 `.md`），保存与当前书籍相关的参考树/参考资料。

- MVP：扫描器在构建知识体系时必须**排除**该目录（及其子目录）下的文件
- MVP：这些文件也不进入 RAG 索引
- 后续：在知识点“深度探索/扩展学习”阶段，可对参考书目目录做检索（独立于主书知识体系）

实现建议：

- 通过配置项声明 `reference_dir_names`（例如：`references`、`参考书目`），扫描时遇到这些目录名即跳过
- 或通过 `exclude_globs`（例如：`**/references/**`）统一排除

> 多目录配置说明：项目配置中可预先声明多个 `BookRoot`，但扫描器每次只处理“当前激活”的一个 `BookRoot`。切换激活项会触发一次重建/重新加载。

### 2.2 文档解析与分段

- 解析目标：
  - 标题层级（`#`~`######`）
  - 段落（空行分隔）
  - 代码块/引用块：保留但标注类型
- 产物：`Document` + `Section` + `Paragraph`（见 05）。

## 3. 知识点提取与体系构建（Agent）

### 3.1 Agent 任务拆分

- **结构提取**：从标题树与段落中推断章节结构
- **知识点候选生成**：识别概念、术语、规则、步骤、API 等
- **去重与合并**：同义项合并，保留别名
- **层级归属**：将 KP 归属到章节/小节
- **关联识别（可选）**：
  - 前置依赖（A 是 B 的前置）
  - 对比关系（A vs B）
  - 包含/组成（A 包含 B）
- **证据片段绑定**：为每个 KP 绑定 1~N 个原文片段引用（带 file/section/offset）

### 3.2 输出格式建议

- 建议用结构化 JSON 输出，并提供 `schema_version`。
- KP 最小字段：`kp_id`、`title`、`chapter_path`、`importance`、`snippet_ids[]`。

> 说明：文档中统一使用 `snippet_ids[]` 表示“指向原文片段的引用”。若实现层需要直接携带片段文本，可在返回给 UI 时做一次 `snippet_ids[] -> snippets[]` 的解析与展开。

### 3.3 重要性排序

- MVP 可用启发式：
  - 出现在标题/小节标题 > 出现在段落
  - 提及频次
  - “定义句式”命中（如“X 是…”、“X 用于…”）
  - 章节层级加权

## 4. 增量与缓存（MVP 简化）

- MVP 可先做**全量重建**：启动时从头构建。
- 可选优化：文件 hash/mtime 未变化则复用上次的解析与 KP（见 05 存储策略）。

## 5. 质量控制

- KP 质量门槛：
  - 必须能找到至少 1 个证据片段
  - 标题不得过长（例如 > 60 字）
  - 避免纯“无意义章节名”（如“概述/总结”）直接成为 KP
- 冲突处理：
  - 同名 KP：按章节路径区分并允许合并为同一个 KP（保留多证据）。

## 6. 相关文档

- [00-总体设计.md](00-总体设计.md)
- [02-知识点浏览与搜索.md](02-知识点浏览与搜索.md)
- [05-数据模型与存储策略（MVP）.md](05-数据模型与存储策略（MVP）.md)

