# 文档扫描与知识体系构建

## 1. 功能概述

负责将原始 Markdown 文档转化为计算机可理解、可检索的知识结构，分为两个主要阶段：

### 1.1 预处理阶段

- **章节扫描与片段切分**：扫描书籍章节，分片段，数据存储到单独文件。
- **数据存储**：预处理结果存储为单独的文件，包含章节树、片段及其位置信息，方便后续数据生成和学习阶段使用。

### 1.2 数据生成阶段

- **知识点提取**：从片段中提取核心术语、定义或概念，每个知识点关联到对应的片段。
- **知识体系构建**：基于章节树和知识点，建立层次化的知识体系。
- **知识图谱构建**：将知识点转换为知识图谱节点，计算节点间的关系权重。
- **PPT内容生成**：为每个章节生成教学PPT，基于章节片段原文、知识点信息和知识点关系。
- **TTS口播说明**：为每个PPT页面生成匹配的口语教案，用于对接TTS功能。

## 2. 输入与配置

- **BasePath**：书籍数据源的根路径，包含主文档。
- **ScanOptions**：扫描配置，包含以下内容：
  - `ExcludedSectionTitles`：不需要处理的章节标题列表（如"本章小结"、"习题"、"参考文献"等）

## 3. 预处理流程

### 3.1 文件发现与预处理

1. **遍历**：递归扫描 `BasePath` 下的所有 Markdown 文件。
2. **解析**：使用 `MarkdownScanner` 解析 Markdown 文档，生成 `Document` 对象。
3. **过滤**：根据 `ExcludedSectionTitles` 过滤不需要处理的章节。

### 3.2 章节解析

- **标题层级识别**：识别文档的标题层级，构建章节树结构。
- **章节树构建**：基于标题层级构建章节树，保留章节间的父子关系。

### 3.3 片段切分

- **片段生成**：将每个章节内容切分为片段。
- **位置信息保留**：保留片段的位置信息（filePath + 标题路径 + 片段/行号范围）。
- **数据存储**：预处理结果存储为单独的文件，包含章节树、片段及其位置信息。

## 4. 数据生成流程

### 4.1 知识点提取

- **输入**：片段内容及其位置信息。
- **处理**：为每个片段调用 `LLMService` 提取知识点，包含 `Title`, `Type`, `Importance`, `DocId`, `ChapterPath` 等属性。
- **关联**：每个知识点关联到对应的片段。
- **校验**：对提取的知识点进行校验和去重，确保数据有效性。

### 4.2 知识体系构建

- **层级关系**：知识点自动挂载到所属章节下。
- **知识树构建**：基于章节树和知识点，构建知识点的层级结构树。
- **关系建立**：建立知识点间的关系（父子、关联、依赖等）。

### 4.3 知识图谱构建

- **节点构建**：将知识点转换为知识图谱节点，保留其类型、重要性、章节路径等属性。
- **关系计算**：自动计算节点间的关系权重，构建语义关联网络（包含、依赖、相关、对比等）。
- **可视化支持**：为知识图谱提供基础的可视化布局支持，包括节点位置、大小和颜色等。

### 4.4 PPT内容生成

- **数据源**：章节片段原文、知识点信息和知识点关系。
- **生成策略**：分为多个部分逐个生成，每个部分对应一个PPT页面。
- **内容组成**：包含文字、图片、图表等教学内容。

### 4.5 TTS口播说明生成

- **生成策略**：为每个PPT页面生成匹配的口语教案。
- **TTS对接**：生成的口播说明用于对接TTS（文本转语音）功能，提供音频讲解。

## 5. 数据更新策略

- **完整扫描**：每次构建时执行完整的扫描和提取流程。
- **增量更新**：在后续版本中支持增量更新，仅处理变动的文件。

## 6. 质量控制

- **知识点提取质量**：确保提取的知识点能回溯到具体的片段。
- **章节过滤**：自动过滤掉不需要处理的章节（如"本章小结"、"习题"、"参考文献"等），提高知识体系的相关性和学习效率。
- **片段关联**：确保所有数据都与片段直接关联。

## 7. 输出数据结构

核心数据结构包括：

- `ChapterTree`：章节树，包含章节层级和片段。
- `Section`：片段，包含文本内容及位置信息。
- `KnowledgePoint`：从片段中提取的知识点，关联到对应的片段。
- `KnowledgeSystem`：知识体系，包含知识点间的关系（父子、关联、依赖等）。
- `KnowledgeGraph`：知识图谱，包含节点和边，用于表示知识点间的语义关系。
- `PPTContent`：PPT内容，基于章节片段原文、知识点信息和知识点关系。
- `TTSScript`：TTS口播说明，为每个PPT页面生成匹配的口语教案。

## 8. 核心服务

- **DocumentScanner**：负责扫描和解析 Markdown 文档，生成章节树和片段。
- **KnowledgeExtractor**：负责从片段中提取知识点，建立知识点与片段的关联。
- **KnowledgeSystemBuilder**：负责构建知识体系，建立知识点间的关系。
- **KnowledgeGraphBuilder**：负责构建知识图谱，计算节点间的关系权重。
- **PPTContentGenerator**：负责生成PPT内容，基于章节片段原文、知识点信息和知识点关系。
- **TTSScriptGenerator**：负责生成TTS口播说明，为每个PPT页面生成匹配的口语教案。
- **DataStore**：负责数据的持久化存储和加载。