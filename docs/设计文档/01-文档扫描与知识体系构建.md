# 文档扫描与知识体系构建

## 1. 功能概述

负责将原始 Markdown 文档转化为计算机可理解、可检索的知识结构。
核心产出包括：

1. **结构化知识库**：章节树、知识点及其关联。
2. **原文索引**：用于精确回溯的文件位置映射。
3. **知识系统**：包含知识点、原文片段和知识树的完整知识结构。

## 2. 输入与配置

- **BookHubId**：书籍中心的唯一标识符，用于区分不同的学习项目。
- **BasePath**：书籍数据源的根路径，包含主文档。
- **ScanOptions**：扫描配置，包含以下内容：
  - `ExcludedSectionTitles`：不需要处理的章节标题列表（如"本章小结"、"习题"、"参考文献"等）

## 3. 扫描流程

### 3.1 文件发现与预处理

1. **遍历**：递归扫描 `BasePath` 下的所有 Markdown 文件。
2. **解析**：使用 `MarkdownScanner` 解析 Markdown 文档，生成 `Document` 对象。
3. **过滤**：根据 `ExcludedSectionTitles` 过滤不需要处理的章节。

### 3.2 知识点提取 (Knowledge Extraction)

1. **结构提取**：
    - 解析 Markdown 文档，构建章节树。
    - 使用深度优先搜索遍历所有层级的章节，只为叶子节点创建原文片段。
2. **概念提取 (Concept Extraction)**：
    - 输入：文档片段内容。
    - 为每个叶子节点章节调用 `LLMService` 提取知识点，包含 `Title`, `Type`, `Importance`, `SnippetIds` 等属性。
    - 对提取的知识点进行校验和去重，确保数据有效性。
3. **关系构建**：
    - **层级关系**：知识点自动挂载到所属章节下。
    - **知识树构建**：构建知识点的层级结构树。

### 3.3 知识系统构建

1. **原文片段整理**：收集所有文档片段，构建原文索引。
2. **知识点整合**：整合所有提取的知识点，构建知识点列表。
3. **生成学习内容**：为每个知识点生成学习内容，包含摘要、层次化内容和幻灯片卡片。
4. **构建知识树**：基于章节结构和知识点关联，构建知识树。
5. **返回结果**：返回 (KnowledgeSystem, List<Document>) 元组给调用方。
6. **知识系统保存**：调用方使用 KnowledgeSystemStore 将构建好的知识系统保存到文件系统。

## 4. 数据更新策略

- **完整扫描**：每次构建时执行完整的扫描和提取流程。
- **增量更新**：在后续版本中支持增量更新，仅处理变动的文件。

## 5. 质量控制

- **知识点提取质量**：确保提取的知识点能回溯到具体的原文片段。
- **章节过滤**：自动过滤掉不需要处理的章节（如"本章小结"、"习题"、"参考文献"等），提高知识体系的相关性和学习效率。

## 6. 输出数据结构

核心数据结构包括：

- `KnowledgeSystem`：包含知识点、原文片段和知识树的完整知识结构。
- `Document`：包含文档内容、章节结构和原文片段的文档对象。
- `KnowledgePoint`：从文档中提取的知识点，包含标题、类型、重要性等属性。
- `SourceSnippet`：文档中的原文片段，包含文本内容及位置信息。

## 7. 核心服务

- **KnowledgeBuilder**：负责协调文档扫描、知识点提取、学习内容生成和知识树构建的主流程。
- **MarkdownScanner**：负责扫描和解析 Markdown 文档，生成 `Document` 对象。
- **LLMService**：负责与 LLM 模型交互，提取知识点和生成学习内容。
- **KnowledgeSystemStore**：负责知识系统的持久化存储和加载。

## 8. 调用流程

1. **初始化**：创建 `KnowledgeBuilder` 实例，注入 `IScannerService`、`ILLMService` 和 `ILogger<KnowledgeBuilder>`。
2. **构建**：调用 `KnowledgeBuilder.BuildAsync` 方法，传入 `BookHubId` 和 `BasePath`。
3. **扫描**：`KnowledgeBuilder` 调用 `IScannerService.ScanAsync` 扫描文档。
4. **提取知识点**：`KnowledgeBuilder` 调用 `ExtractKnowledgePointsAsync` 提取知识点。
5. **生成学习内容**：`KnowledgeBuilder` 调用 `GenerateLearningContentForPointsAsync` 为每个知识点生成学习内容。
6. **构建知识树**：`KnowledgeBuilder` 调用 `BuildKnowledgeTree` 构建知识树。
7. **返回结果**：`KnowledgeBuilder` 返回 `(KnowledgeSystem, List<Document>)` 元组给调用方。
8. **保存**：调用方使用 `KnowledgeSystemStore.SaveAsync` 保存知识系统到文件系统。

```

