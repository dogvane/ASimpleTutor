# 文档扫描处理流程 - 流程图文档

## 1. 整体架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             文档扫描与知识体系构建系统                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │  预处理阶段  │    │ 数据生成阶段 │    │  学习阶段   │    │  存储阶段   │  │
│  │             │    │             │    │             │    │             │  │
│  │ • 文档扫描   │    │ • 知识点提取 │    │ • 章节导航  │    │ • 文件存储  │  │
│  │ • 章节划分   │    │ • 知识体系   │    │ • PPT学习  │    │ • 数据库    │  │
│  │ • 片段切分   │    │ • 知识图谱   │    │ • TTS口播  │    │ • 缓存      │  │
│  │ • 数据存储   │    │ • PPT生成   │    │             │    │             │  │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘  │
│         │                  │                   │                   │        │
│         └──────────────────┼───────────────────┼───────────────────┘        │
│                            │                   │                            │
│  ┌─────────────────────────▼───────────────────▼──────────────────────────┐  │
│  │                        统一的数据模型与接口                              │  │
│  │                                                                        │  │
│  │  Document ──┬── Section ──┬── KnowledgePoint ──┬── KnowledgeSystem     │  │
│  │             │             │                     │                       │  │
│  │  SlideCard  │  KnowledgeGraph │  TTSScript     │  ChapterTree          │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. 核心处理流程总览

```mermaid
flowchart TD
    Start[开始文档扫描] --> Input[输入配置]
    
    Input --> PreProcess{预处理阶段}
    PreProcess --> Scan[文档扫描]
    Scan --> Parse[文档解析]
    Parse --> Section[章节划分]
    Section --> StorePre[预处理数据存储]
    
    StorePre --> DataGen{数据生成阶段}
    DataGen --> KP[知识点提取]
    KP --> KS[知识体系构建]
    KS --> KG[知识图谱构建]
    KG --> PPT[PPT内容生成]
    PPT --> TTS[TTS口播说明生成]
    
    TTS --> SaveData{数据保存阶段}
    SaveData --> SaveKP[保存知识点数据]
    SaveKP --> SaveDoc[保存文档结构]
    SaveDoc --> SaveGraph[保存知识图谱]
    SaveGraph --> SavePPT[保存PPT卡片（含SpeechScript）]
    
    SavePPT --> VerifySave{验证保存结果}
    VerifySave -->|保存成功| Learning{学习阶段}
    VerifySave -->|保存失败| RetrySave[重试保存]
    
    RetrySave -->|重试成功| Learning
    RetrySave -->|重试失败| LogError[记录错误]
    
    LogError --> Learning
    Learning --> Nav[章节树导航]
    Nav --> Display[PPT学习界面]
    Display --> Audio[TTS音频讲解]
    
    Audio --> End[完成]
```

## 3. 详细处理流程

### 3.1 预处理阶段流程

```mermaid
flowchart TD
    Start[开始预处理] --> Config[加载配置]
    Config --> PathCheck{检查路径}
    
    PathCheck -->|路径无效| Error[记录错误并返回]
    PathCheck -->|路径有效| ScanFiles[扫描文件]
    
    ScanFiles --> FileDiscovery[文件发现]
    FileDiscovery --> FilterFiles{文件过滤}
    
    FilterFiles -->|隐藏/临时文件| SkipHidden[跳过文件]
    FilterFiles -->|排除目录文件| SkipExcluded[跳过文件]
    FilterFiles -->|有效文件| ParseFile[解析文件]
    
    SkipHidden --> ScanFiles
    SkipExcluded --> ScanFiles
    
    ParseFile --> ReadContent[读取内容]
    ReadContent --> ExtractTitle[提取标题]
    ExtractTitle --> BuildTree[构建标题树]
    
    BuildTree --> Phase1[阶段一:全局预扫描]
    Phase1 --> Phase2[阶段二:确定最优层级]
    Phase2 --> Phase3[阶段三:正式划分]
    
    Phase3 --> BuildSections[构建章节结构]
    BuildSections --> ExcludeCheck{排除检查}
    
    ExcludeCheck -->|排除章节| MarkExcluded[标记排除]
    ExcludeCheck -->|保留章节| AddSection[添加到文档]
    
    MarkExcluded --> BuildSections
    AddSection --> MoreFiles{更多文件?}
    
    MoreFiles -->|是| ScanFiles
    MoreFiles -->|否| StoreData[存储预处理数据]
    
    StoreData --> EndPre[预处理完成]
```

### 3.2 章节划分算法流程（局部动态分层策略）

```mermaid
flowchart TD
    StartSectioning[开始章节划分] --> Lines[输入文档行数组]
    
    Lines --> Phase1[阶段一:全局预扫描]
    
    subgraph Phase1 [阶段一:全局预扫描]
        P1_1[文档遍历与标题提取]
        P1_2[构建标题树]
        P1_3[计算各层级平均长度]
        
        P1_1 --> P1_2 --> P1_3
    end
    
    Phase1 --> Phase2[阶段二:确定最优层级]
    
    subgraph Phase2 [阶段二:确定最优层级]
        P2_1[分析层级长度分布]
        P2_2[局部动态分层策略]
        P2_3[动态调整目标值]
        P2_4[分层决策]
        
        P2_1 --> P2_2 --> P2_3 --> P2_4
    end
    
    Phase2 --> Phase3[阶段三:正式划分]
    
    subgraph Phase3 [阶段三:正式划分]
        P3_1[根据最优层级构建章节]
        P3_2[片段归属]
        P3_3[内容长度统计]
        
        P3_1 --> P3_2 --> P3_3
    end
    
    Phase3 --> Output[输出章节结构]
```

### 3.3 局部动态分层策略详细流程

```mermaid
flowchart TD
    StartStrategy[开始分层策略] --> ForEachParent[遍历每个父章节]
    
    ForEachParent --> CalcLevelStats[计算不同层级统计]
    CalcLevelStats --> AdjustTarget[动态调整目标值]
    
    AdjustTarget --> Rule1[规则一:目标长度匹配]
    Rule1 -->|平均长度接近目标值| Score1[得分+]
    Rule1 -->|平均长度远离目标值| Score2[得分-]
    
    Score1 --> Rule2[规则二:避免过细划分]
    Score2 --> Rule2
    
    Rule2 -->|平均长度<MinLength| Score3[得分-]
    Rule2 -->|平均长度>=MinLength| Score4[得分+]
    
    Score3 --> Rule3[规则三:避免过粗划分]
    Score4 --> Rule3
    
    Rule3 -->|平均长度>MaxLength| Score5[得分-]
    Rule3 -->|平均长度<=MaxLength| Score6[得分+]
    
    Score5 --> Rule4[规则四:层级连续性]
    Score6 --> Rule4
    
    Rule4 -->|层级跳跃| Score7[得分-]
    Rule4 -->|层级连续| Score8[得分+]
    
    Score7 --> Rule5[规则五:最小深度优先]
    Score8 --> Rule5
    
    Rule5 -->|多个层级得分相近| ChooseShallow[选择较浅层级]
    Rule5 -->|得分差异明显| ChooseBest[选择最高分层级]
    
    ChooseShallow --> StoreDecision[存储决策]
    ChooseBest --> StoreDecision
    
    StoreDecision --> MoreParents{更多父章节?}
    MoreParents -->|是| ForEachParent
    MoreParents -->|否| EndStrategy[分层策略完成]
```

### 3.4 知识点提取流程

```mermaid
flowchart TD
    StartExtract[开始知识点提取] --> CollectSections[收集所有Section]
    
    CollectSections --> ParallelProcess[并行处理所有Section]
    
    subgraph ParallelProcess [并行处理流程]
        PP1[读取Section内容]
        PP2[构建LLM提示词]
        PP3[调用LLM服务]
        PP4[解析JSON响应]
        PP5[验证知识点]
        
        PP1 --> PP2 --> PP3 --> PP4 --> PP5
    end
    
    ParallelProcess --> MergeResults[合并所有知识点]
    MergeResults --> Deduplicate[去重处理]
    Deduplicate --> Validate[整体验证]
    
    Validate -->|验证失败| LogError[记录错误]
    Validate -->|验证成功| ConvertToModel[转换为KnowledgePoint模型]
    
    LogError --> ConvertToModel
    ConvertToModel --> StoreKP[存储知识点]
    StoreKP --> EndExtract[知识点提取完成]
```

### 3.5 知识体系构建流程

```mermaid
flowchart TD
    StartKS[开始知识体系构建] --> Input[输入:知识点列表 + 章节树]
    
    Input --> BuildTree[构建知识树]
    
    subgraph BuildTree [构建知识树]
        BT1[知识点挂载到章节]
        BT2[建立层级关系]
        BT3[计算重要性权重]
        BT4[生成知识树结构]
        
        BT1 --> BT2 --> BT3 --> BT4
    end
    
    BuildTree --> BuildGraph[构建知识图谱]
    
    subgraph BuildGraph [构建知识图谱]
        BG1[知识点转换为节点]
        BG2[计算节点间关系]
        BG3[建立语义关联]
        BG4[生成图谱布局]
        
        BG1 --> BG2 --> BG3 --> BG4
    end
    
    BuildGraph --> GeneratePPT[生成PPT内容]
    
    subgraph GeneratePPT [生成PPT内容]
        GP1[基于章节片段]
        GP2[整合知识点信息]
        GP3[利用知识图谱]
        GP4[生成幻灯片卡片]
        
        GP1 --> GP2 --> GP3 --> GP4
    end
    
    GeneratePPT --> GenerateTTS[生成TTS口播说明]
    
    subgraph GenerateTTS [生成TTS口播说明]
        GT1[为每个PPT页面生成]
        GT2[创建口语教案]
        GT3[优化朗读节奏]
        GT4[生成TTS脚本]
        
        GT1 --> GT2 --> GT3 --> GT4
    end
    
    GenerateTTS --> StoreKS[存储知识体系]
    StoreKS --> EndKS[知识体系构建完成]
```

## 4. 数据流图

### 4.1 数据转换流程

```
原始文档 (Markdown)
     │
     ▼
Document 对象
     │
     ▼
Section 列表 (章节树)
     │
     ▼
KnowledgePoint 列表
     │
     ▼
KnowledgeSystem (知识体系)
     │
     ▼
KnowledgeGraph (知识图谱)
     │
     ▼
SlideCard 列表 (PPT内容)
     │
     ▼
TTSScript 列表 (口播说明)
```

### 4.2 数据存储流程

```
预处理数据 ────┐
               │
知识点数据 ─────┤
               ├──▶ 文件存储 (JSON格式)
知识体系数据 ───┤
               │
PPT内容 ───────┤
               │
TTS脚本 ───────┘
     │
     ▼
SQLite数据库 ───┐
               ├──▶ 持久化存储
缓存数据 ───────┘
```

## 5. 异常处理流程

```mermaid
flowchart TD
    StartError[开始异常处理] --> DetectError[检测异常]
    
    DetectError --> ErrorType{异常类型?}
    
    ErrorType -->|文件读取错误| FileError[文件错误处理]
    ErrorType -->|解析错误| ParseError[解析错误处理]
    ErrorType -->|LLM调用错误| LLMError[LLM错误处理]
    ErrorType -->|存储错误| StorageError[存储错误处理]
    
    FileError --> LogFileError[记录文件错误]
    ParseError --> LogParseError[记录解析错误]
    LLMError --> LogLLMError[记录LLM错误]
    StorageError --> LogStorageError[记录存储错误]
    
    LogFileError --> SkipFile[跳过问题文件]
    LogParseError --> SkipSection[跳过问题章节]
    LogLLMError --> RetryLLM[重试或跳过]
    LogStorageError --> RetryStorage[重试存储]
    
    SkipFile --> ContinueProcess[继续处理]
    SkipSection --> ContinueProcess
    RetryLLM --> ContinueProcess
    RetryStorage --> ContinueProcess
    
    ContinueProcess --> MonitorProgress[监控进度]
    MonitorProgress --> EndError[异常处理完成]
```

## 6. 配置参数流程图

```mermaid
flowchart TD
    StartConfig[开始配置加载] --> ReadConfig[读取配置文件]
    
    ReadConfig --> ValidateConfig[验证配置]
    
    ValidateConfig -->|配置有效| LoadOptions[加载配置选项]
    ValidateConfig -->|配置无效| UseDefaults[使用默认值]
    
    LoadOptions --> SectioningConfig[章节划分配置]
    UseDefaults --> SectioningConfig
    
    subgraph SectioningConfig [章节划分配置]
        SC1[TargetLength: 目标分段长度]
        SC2[MinLength: 最小分段长度]
        SC3[MaxLength: 最大分段长度]
        SC4[SizeThresholds: 章节规模阈值]
        SC5[StrategyWeights: 策略权重]
        SC6[ExcludedSectionTitles: 排除章节标题]
    end
    
    SectioningConfig --> InjectServices[注入服务]
    InjectServices --> EndConfig[配置加载完成]
```

## 7. 性能优化流程图

```mermaid
flowchart TD
    StartPerf[开始性能优化] --> ParallelProcessing[并行处理]
    
    ParallelProcessing --> CacheStrategy[缓存策略]
    CacheStrategy --> MemoryManagement[内存管理]
    
    MemoryManagement --> Optimize1[优化1:限制搜索深度]
    MemoryManagement --> Optimize2[优化2:分批处理]
    MemoryManagement --> Optimize3[优化3:流式处理]
    
    Optimize1 --> Monitor1[监控内存使用]
    Optimize2 --> Monitor2[监控CPU使用]
    Optimize3 --> Monitor3[监控I/O性能]
    
    Monitor1 --> AdjustParams[调整参数]
    Monitor2 --> AdjustParams
    Monitor3 --> AdjustParams
    
    AdjustParams --> EndPerf[性能优化完成]
```

## 8. 核心算法复杂度分析

### 8.1 时间复杂度

```
文档扫描: O(n) - n为文件数量
章节划分: O(m) - m为文档行数
知识点提取: O(p) - p为Section数量（并行处理）
知识图谱构建: O(k²) - k为知识点数量
```

### 8.2 空间复杂度

```
文档解析: O(m) - m为文档内容大小
章节树: O(s) - s为章节数量
知识点存储: O(k) - k为知识点数量
知识图谱: O(k + e) - k为节点数，e为边数
```

## 9. 关键决策点

### 9.1 章节划分决策矩阵

| 条件 | 决策 | 理由 |
|------|------|------|
| 平均长度接近目标值 | 选择该层级 | 最优匹配 |
| 平均长度 < MinLength | 跳过该层级 | 避免过细划分 |
| 平均长度 > MaxLength | 继续寻找更细层级 | 避免过粗划分 |
| 多个层级得分相近 | 选择较浅层级 | 最小深度优先 |
| 层级跳跃 | 降低得分 | 保持层级连续性 |

### 9.2 异常处理决策矩阵

| 异常类型 | 处理策略 | 恢复机制 |
|----------|----------|----------|
| 文件读取失败 | 跳过文件 | 记录日志，继续处理其他文件 |
| 解析错误 | 跳过章节 | 使用默认解析，记录错误 |
| LLM调用失败 | 重试3次 | 指数退避重试，最后跳过 |
| 存储失败 | 重试存储 | 检查存储空间，重试机制 |

## 10. 验证检查点

### 10.1 预处理阶段验证

- [ ] 所有Markdown文件已扫描
- [ ] 排除目录已正确过滤
- [ ] 章节树结构完整
- [ ] 内容长度统计准确
- [ ] 排除章节已正确标记

### 10.2 数据生成阶段验证

- [ ] 知识点提取完整
- [ ] 知识点类型有效
- [ ] 重要性权重合理
- [ ] 知识图谱关系正确
- [ ] PPT内容生成完整
- [ ] TTS脚本可读性强

### 10.3 学习阶段验证

- [ ] 章节树导航正常
- [ ] PPT显示正确
- [ ] TTS音频可播放
- [ ] 知识图谱可视化正常

## 11. 扫描完成后的文件保存操作

### 11.1 整体存储结构

文档扫描完成后，系统会按照以下目录结构保存数据：

```
saves/
  ├── {BookHubId}/                    # 书籍中心ID命名的目录
  │   ├── knowledge-points.json       # 知识点数据文件
  │   ├── documents.json              # 文档章节结构文件
  │   ├── knowledge-graph.json        # 知识图谱文件
  │   └── slide-cards/                # 幻灯片卡片目录
  │       ├── kp_{KpId}.json          # 单个知识点PPT卡片（包含SpeechScript）
  │       └── ...
```

### 11.2 文件保存流程图

```mermaid
flowchart TD
    StartSave[开始保存操作] --> CheckData{数据完整性检查}
    
    CheckData -->|数据完整| ParallelSave[并行保存]
    CheckData -->|数据不完整| LogError[记录错误并跳过]
    
    subgraph ParallelSave [并行保存流程]
        PS1[保存知识点数据]
        PS2[保存文档结构]
        PS3[保存知识图谱]
        PS4[生成并保存PPT卡片]
        
        PS1 --> PS1_Done[知识点保存完成]
        PS2 --> PS2_Done[文档保存完成]
        PS3 --> PS3_Done[图谱保存完成]
        PS4 --> PS4_Done[PPT保存完成]
    end
    
    LogError --> EndSave[保存操作结束]
    ParallelSave --> VerifySave[验证保存结果]
    
    VerifySave -->|所有文件保存成功| UpdateProgress[更新进度状态]
    VerifySave -->|部分文件保存失败| RetryFailed[重试失败文件]
    
    UpdateProgress --> MarkComplete[标记扫描完成]
    RetryFailed -->|重试成功| UpdateProgress
    RetryFailed -->|重试失败| LogPersistentError[记录持久性错误]
    
    LogPersistentError --> UpdateProgress
    MarkComplete --> EndSave
```

### 11.3 保存文件类型和内容

#### 11.3.1 知识点数据文件
**文件名**: `knowledge-points.json`  
**存储服务**: [KnowledgeSystemStore.cs](../../src/ASimpleTutor.Core/Services/KnowledgeSystemStore.cs)  
**内容类**: `KnowledgePointsSaveModel`  
**关联模型**: [KnowledgePoint.cs](../../src/ASimpleTutor.Core/Models/KnowledgePoint.cs)

#### 11.3.2 文档章节结构文件
**文件名**: `documents.json`  
**存储服务**: [KnowledgeSystemStore.cs](../../src/ASimpleTutor.Core/Services/KnowledgeSystemStore.cs)  
**内容类**: `List<Document>`  
**关联模型**: [Document.cs](../../src/ASimpleTutor.Core/Models/Document.cs)

#### 11.3.3 知识图谱文件
**文件名**: `knowledge-graph.json`  
**存储服务**: [KnowledgeGraphStore.cs](../../src/ASimpleTutor.Core/Services/KnowledgeGraphStore.cs)  
**内容类**: `KnowledgeGraph`  
**关联模型**: [KnowledgeGraph.cs](../../src/ASimpleTutor.Core/Models/KnowledgeGraph.cs)

#### 11.3.4 幻灯片卡片文件
**目录名**: `slide-cards/`  
**文件名格式**: `kp_{KpId}.json`  
**内容类**: `SlideCard`  
**关联模型**: [SlideCard](../../src/ASimpleTutor.Core/Models/KnowledgePoint.cs#L122-L164) (在KnowledgePoint.cs中定义)

#### 11.3.5 TTS口播说明（内嵌在SlideCard中）
**属性名**: `SpeechScript`  
**位置**: 内嵌在`SlideCard`模型的`SpeechScript`属性中  
**内容类**: `string` (口语化讲解脚本)  
**关联模型**: [SlideCard](../../src/ASimpleTutor.Core/Models/KnowledgePoint.cs#L122-L164) 中的 `SpeechScript` 属性

### 11.4 数据关联关系

```
Document (文档)
  ├── Section (章节)
  │     └── KnowledgePoint (知识点)
  │           ├── KnowledgeGraphNode (知识图谱节点)
  │           └── SlideCard (幻灯片卡片，包含SpeechScript属性)
  └── KnowledgeSystem (知识体系)
        └── KnowledgeGraph (知识图谱)
```

### 11.5 存储服务类说明

| 存储服务类 | 文件路径 | 主要功能 |
|------------|----------|----------|
| `KnowledgeSystemStore` | [KnowledgeSystemStore.cs](../../src/ASimpleTutor.Core/Services/KnowledgeSystemStore.cs) | 保存和加载知识系统数据 |
| `KnowledgeGraphStore` | [KnowledgeGraphStore.cs](../../src/ASimpleTutor.Core/Services/KnowledgeGraphStore.cs) | 保存和加载知识图谱数据 |
| `LearningProgressStore` | [LearningProgressStore.cs](../../src/ASimpleTutor.Core/Services/LearningProgressStore.cs) | 保存和加载学习进度 |
| `MistakeNotebookStore` | [MistakeNotebookStore.cs](../../src/ASimpleTutor.Core/Services/MistakeNotebookStore.cs) | 保存和加载错题记录 |

### 11.6 数据持久化流程

#### 11.6.1 保存流程
```
1. 扫描完成 → 生成Document和Section对象
2. 知识点提取 → 生成KnowledgePoint对象
3. 知识体系构建 → 生成KnowledgeSystem对象
4. 知识图谱构建 → 生成KnowledgeGraph对象
5. PPT生成 → 生成SlideCard对象（包含SpeechScript属性）
6. 并行保存到文件系统
```

#### 11.6.2 加载流程
```
1. 检查存储目录是否存在
2. 并行加载知识点和文档数据
3. 重建知识树结构
4. 加载知识图谱数据
5. 加载学习进度数据
6. 返回完整的知识系统
```

### 11.7 关键数据模型类清单

| 类名 | 文件路径 | 描述 |
|------|----------|------|
| `Document` | [Document.cs](../../src/ASimpleTutor.Core/Models/Document.cs) | 文档模型 |
| `Section` | [Section.cs](../../src/ASimpleTutor.Core/Models/Section.cs) | 章节模型 |
| `KnowledgePoint` | [KnowledgePoint.cs](../../src/ASimpleTutor.Core/Models/KnowledgePoint.cs) | 知识点模型 |
| `KnowledgeSystem` | [KnowledgeSystem.cs](../../src/ASimpleTutor.Core/Models/KnowledgeSystem.cs) | 知识体系模型 |
| `KnowledgeGraph` | [KnowledgeGraph.cs](../../src/ASimpleTutor.Core/Models/KnowledgeGraph.cs) | 知识图谱模型 |
| `SlideCard` | [KnowledgePoint.cs#L122-L164](../../src/ASimpleTutor.Core/Models/KnowledgePoint.cs#L122-L164) | 幻灯片卡片模型（包含SpeechScript属性） |

### 11.8 设计文档参考

- [05-数据模型与存储策略.md](../05-数据模型与存储策略.md) - 存储策略设计
- [01-文档扫描与知识体系构建.md](../01-文档扫描与知识体系构建.md) - 整体架构设计

---

## 附录：流程图符号说明

```
矩形: 处理步骤
菱形: 决策点
平行四边形: 输入/输出
圆形: 开始/结束
双矩形: 子流程
虚线框: 并行处理
箭头: 数据流/控制流
```

## 附录：关键配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| TargetLength | 3000 | 目标分段长度（字符） |
| MinLength | 500 | 最小分段长度（字符） |
| MaxLength | 10000 | 最大分段长度（字符） |
| SmallThreshold | 5000 | 小章节阈值（字符） |
| MediumThreshold | 20000 | 中等章节阈值（字符） |

---

*文档创建日期: 2026-02-21*
*最后更新日期: 2026-02-21*
*版本: 1.1*