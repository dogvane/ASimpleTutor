# 简化集成设计：LightRAG 底层 + ASimpleTutor 上层

## 1. 设计原则

- **LightRAG 极简**：只提供文档存储和向量检索，接口最小化
- **ASimpleTutor 自治**：学习逻辑完全自主，不依赖 LightRAG 的知识图谱
- **单向依赖**：ASimpleTutor 依赖 LightRAG，LightRAG 不感知 ASimpleTutor
- **接口最小化**：每个方向只定义 3~4 个核心接口

## 2. 架构分层

```
┌─────────────────────────────────────┐
│        ASimpleTutor.Core            │
│  知识点提取 │ 学习内容生成 │ 习题    │
└──────────────┬──────────────────────┘
               │ ISimpleRagService
┌──────────────┴──────────────────────┐
│           LightRAG.NET              │
│    文档存储 │ 向量检索 │ LLM 调用    │
└─────────────────────────────────────┘
```

## 3. LightRAG 接口（仅 3 个核心方法）

```
ISimpleRagService
├── InsertAsync(documentId, content, metadata)
│   → 返回 chunks 列表
├── SearchAsync(query, topK)
│   → 返回检索结果列表
└── ClearAsync()
    → 清空工作区
```

## 4. ASimpleTutor 核心接口

```
IKnowledgeBuilder
└── BuildAsync(root) → 知识系统

ILearningGenerator
└── GenerateAsync(kp) → 学习内容包

IExerciseGenerator
└── GenerateAsync(kp, count) → 练习题列表

IExerciseFeedback
└── JudgeAsync(question, answer) → 答题反馈
```

## 5. ASimpleTutor 自建组件

### 5.1 SourceTracker

**职责**：维护 chunk → 原始文档的映射，解决原文追溯问题

```
LightRAG: chunkId + content
SourceTracker: chunkId → filePath + headingPath + lineNumbers
```

### 5.2 SourceTracker 工作流程

```
文档扫描
    ↓
LightRAG.Insert → chunks
    ↓
SourceTracker.Track → 建立映射关系
    ↓
后续查询时：SourceTracker.GetSource(chunkId) → 原文片段
```

## 6. 数据流

```
┌─────────────────────────────────────────────────────────────┐
│ 文档扫描                                                      │
└─────────────────────────┬───────────────────────────────────┘
                          ↓
┌─────────────────────────┴───────────────────────────────────┐
│ LightRAG.Insert → chunks + 向量化                           │
└─────────────────────────┬───────────────────────────────────┘
                          ↓
┌─────────────────────────┴───────────────────────────────────┐
│ SourceTracker.Track → chunk → 原文位置映射                   │
└─────────────────────────┬───────────────────────────────────┘
                          ↓
┌─────────────────────────┴───────────────────────────────────┐
│ 知识体系构建                                                   │
│ 1. LightRAG.Search → 相关 chunks                            │
│ 2. LLM 提取知识点                                             │
│ 3. 构建知识树                                                 │
└─────────────────────────┬───────────────────────────────────┘
                          ↓
┌─────────────────────────┴───────────────────────────────────┐
│ 学习内容生成                                                   │
│ 1. LightRAG.Search → chunks                                 │
│ 2. SourceTracker.GetSource → 原文片段                        │
│ 3. LLM 生成学习内容                                           │
└─────────────────────────┬───────────────────────────────────┘
                          ↓
┌─────────────────────────┴───────────────────────────────────┐
│ 习题生成与反馈                                                 │
│ 1. LightRAG.Search → chunks                                 │
│ 2. LLM 生成习题                                               │
│ 3. LLM 评判答案                                               │
└─────────────────────────────────────────────────────────────┘
```

## 7. 项目结构

```
src/
├── LightRAG.NET/
│   └── LightRAG.Core/
│       ├── Interfaces/
│       │   └── ISimpleRagService.cs   // 3 个方法
│       └── Services/
│           └── SimpleRagService.cs
│
├── ASimpleTutor.Core/
│   ├── Models/
│   │   ├── KnowledgePoint.cs
│   │   ├── LearningPack.cs
│   │   └── Exercise.cs
│   ├── Interfaces/
│   │   ├── IKnowledgeBuilder.cs
│   │   ├── ILearningGenerator.cs
│   │   ├── IExerciseGenerator.cs
│   │   └── IExerciseFeedback.cs
│   ├── Services/
│   │   ├── SourceTracker.cs          // 自建
│   │   ├── KnowledgeBuilder.cs
│   │   ├── LearningGenerator.cs
│   │   └── ExerciseGenerator.cs
│   └── ASimpleTutor.Core.csproj
│
└── ASimpleTutor.Api/
    ├── Program.cs
    └── Endpoints/
        ├── KnowledgeEndpoints.cs
        ├── LearningEndpoints.cs
        └── ExerciseEndpoints.cs
```

## 8. 核心数据模型

### 8.1 知识点

```
KnowledgePoint
├── Id: string
├── Title: string
├── Description: string
├── ChapterPath: string
├── SourceChunkIds: List<string>    // 关联 LightRAG chunks
└── Importance: float
```

### 8.2 原文片段（可追溯）

```
SourceSnippet
├── ChunkId: string
├── Content: string
├── FilePath: string
├── HeadingPath: List<string>
├── StartLine: int
└── EndLine: int
```

### 8.3 学习内容包

```
LearningPack
├── KnowledgePointId: string
├── Summary: { definition, keyPoints[], pitfalls[] }
├── Levels: [{ level, title, content }]
└── Snippets: SourceSnippet[]
```

### 8.4 练习题

```
Exercise
├── Id: string
├── Type: 枚举(选择/填空/简答)
├── Question: string
├── Options: string[]          // 选择题
├── CorrectAnswer: string
└── KeyPoints: string[]        // 给用户自评
```

## 9. 总结

### LightRAG 接口

| 方法 | 输入 | 输出 |
|------|------|------|
| InsertAsync | documentId, content, metadata | List<Chunk> |
| SearchAsync | query, topK | List<SearchResult> |
| ClearAsync | - | - |

### ASimpleTutor 接口

| 接口 | 方法 | 职责 |
|------|------|------|
| IKnowledgeBuilder | BuildAsync | 构建知识体系 |
| ILearningGenerator | GenerateAsync | 生成学习内容 |
| IExerciseGenerator | GenerateAsync | 生成练习题 |
| IExerciseFeedback | JudgeAsync | 评判答案 |

### 简化要点

1. LightRAG 只管"存"和"搜"
2. ASimpleTutor 自主处理所有学习逻辑
3. 原文追溯由 ASimpleTutor 自建 SourceTracker 维护
4. 双方接口各 3~4 个方法

## 10. 相关文档

- [10-模块边界划分.md](10-模块边界划分.md)
- [11-LightRAG集成设计.md](11-LightRAG集成设计.md)
