# 设置功能设计文档

## 一、功能概述

设置功能允许用户通过前端界面配置系统相关的基础设置，包括：

### 1.1 LLM 配置
- LLM API Key
- LLM Base URL
- 模型名称（Model）

### 1.2 TTS 配置
- TTS API Key
- TTS Base URL
- 语音模型（Voice）

用户可以通过界面修改配置，配置会持久化到 `appsettings.user.json` 文件中。

## 二、配置存储机制

### 2.1 三层配置结构

```
appsettings.json          ← 默认配置（系统提供，保持不变）
    ↓ (优先级)
appsettings.local.json    ← 开发环境本地配置（已存在）
    ↓ (优先级)
appsettings.user.json     ← 用户自定义配置（运行时生成）
```

### 2.2 配置优先级

`appsettings.user.json` > `appsettings.local.json` > `appsettings.json`

### 2.3 文件说明

| 文件 | 用途 | 提交到 git |
|------|------|-----------|
| `appsettings.json` | 系统默认配置 | 是 |
| `appsettings.local.json` | 开发环境本地配置 | 否 |
| `appsettings.user.json` | 用户通过界面修改的配置 | 否 |

## 三、数据模型

### 3.1 请求 DTO

#### LlmSettingsRequest

```csharp
public class LlmSettingsRequest
{
    public string ApiKey { get; set; }   // API 密钥
    public string BaseUrl { get; set; }  // API 基础 URL
    public string Model { get; set; }    // 模型名称
}
```

#### TestLlmConnectionRequest

```csharp
public class TestLlmConnectionRequest
{
    public string ApiKey { get; set; }
    public string BaseUrl { get; set; }
    public string Model { get; set; }
}
```

#### TtsSettingsRequest

```csharp
public class TtsSettingsRequest
{
    public string ApiKey { get; set; }   // API 密钥
    public string BaseUrl { get; set; }  // API 基础 URL
    public string Voice { get; set; }    // 语音模型
}
```

### 3.2 响应 DTO

#### LlmSettingsResponse

```csharp
public class LlmSettingsResponse
{
    public string ApiKeyMasked { get; set; }  // 脱敏后的 API Key（sk-***...xyz）
    public string BaseUrl { get; set; }
    public string Model { get; set; }
    public bool IsValid { get; set; }        // 配置是否有效
    public string? LastTested { get; set; }  // 最后测试时间
}
```

#### TestLlmConnectionResponse

```csharp
public class TestLlmConnectionResponse
{
    public bool Success { get; set; }
    public string Message { get; set; }
    public string? ModelInfo { get; set; }   // 模型响应片段
    public long ResponseTimeMs { get; set; }
}
```

#### TtsSettingsResponse

```csharp
public class TtsSettingsResponse
{
    public string ApiKeyMasked { get; set; }  // 脱敏后的 API Key
    public string BaseUrl { get; set; }
    public string Voice { get; set; }
    public bool IsValid { get; set; }         // 配置是否有效
}
```

## 四、API 接口

### 4.1 获取 LLM 配置

**请求**
```
GET /api/v1/settings/llm
```

**响应**
```json
{
  "items": [
    {
      "apiKeyMasked": "sk-abc...xyz",
      "baseUrl": "https://api.openai.com/v1",
      "model": "gpt-4",
      "isValid": true,
      "lastTested": null
    }
  ]
}
```

### 4.2 更新 LLM 配置

**请求**
```
PUT /api/v1/settings/llm
Content-Type: application/json

{
  "apiKey": "sk-your-api-key",
  "baseUrl": "https://api.openai.com/v1",
  "model": "gpt-4"
}
```

**响应**
```json
{
  "success": true,
  "message": "配置已保存并实时生效",
  "items": [
    {
      "apiKeyMasked": "sk-your...key",
      "baseUrl": "https://api.openai.com/v1",
      "model": "gpt-4",
      "isValid": true,
      "lastTested": null
    }
  ]
}
```

### 4.3 测试 LLM 连接

**请求**
```
POST /api/v1/settings/llm/test
Content-Type: application/json

{
  "apiKey": "sk-your-api-key",
  "baseUrl": "https://api.openai.com/v1",
  "model": "gpt-4"
}
```

**响应**
```json
{
  "success": true,
  "message": "连接成功",
  "items": [
    {
      "success": true,
      "message": "连接成功",
      "modelInfo": "你好！我是...",
      "responseTimeMs": 1234
    }
  ]
}
```

### 4.4 获取 TTS 配置

**请求**
```
GET /api/v1/settings/tts
```

**响应**
```json
{
  "items": [
    {
      "apiKeyMasked": "sk-abc...xyz",
      "baseUrl": "https://api.openai.com/v1",
      "voice": "alloy",
      "isValid": true
    }
  ]
}
```

### 4.5 更新 TTS 配置

**请求**
```
PUT /api/v1/settings/tts
Content-Type: application/json

{
  "apiKey": "sk-your-api-key",
  "baseUrl": "https://api.openai.com/v1",
  "voice": "alloy"
}
```

**响应**
```json
{
  "success": true,
  "message": "配置已保存并实时生效",
  "items": [
    {
      "apiKeyMasked": "sk-your...key",
      "baseUrl": "https://api.openai.com/v1",
      "voice": "alloy",
      "isValid": true
    }
  ]
}
```

## 五、前端组件

### 5.1 SettingsDialog 组件

**Props**

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| open | Boolean | false | 对话框是否打开 |

**Events**

| 事件 | 参数 | 说明 |
|------|------|------|
| close | - | 关闭对话框 |
| saved | - | 配置保存成功 |

**功能**

对话框包含两个标签页：

**LLM 配置标签页**
- 服务商选择（OpenAI、DeepSeek、通义千问、Ollama、自定义）
- API Key 输入（密码类型，脱敏显示）
- Base URL 输入（带快捷预设和自定义选项）
- Model 输入（按服务商分组的快捷预设）
- 测试连接按钮
- 表单验证
- 保存功能

**TTS 配置标签页**
- API Key 输入（密码类型，脱敏显示）
- Base URL 输入（带快捷预设）
- Voice 选择（alloy、echo、fable、onyx、nova、shimmer、自定义）
- 表单验证
- 保存功能

### 5.2 集成方式

1. **TopBar 组件**：添加设置按钮（齿轮图标）
2. **App.vue**：管理对话框状态和处理保存事件

## 六、安全考虑

1. **API Key 脱敏显示**：返回时只显示前 7 位和后 4 位字符
2. **配置文件不提交**：`appsettings.user.json` 已添加到 `.gitignore`
3. **密码输入**：前端使用 `type="password"` 隐藏输入
4. **实时生效**：配置保存后自动更新 LLM 服务，无需重启

## 七、实现说明

### 7.1 动态配置更新

配置保存后会自动调用 `ILLMService.UpdateConfig()` 方法，实时更新 LLM 服务的内部客户端实现：

1. 更新内存中的 `AppConfig` 对象
2. 调用 `LLMService.UpdateConfig()` 重新初始化 OpenAI 客户端
3. 持久化配置到 `appsettings.user.json`
4. 后续 LLM 调用自动使用新配置

### 7.2 线程安全

`LLMService.UpdateConfig()` 使用 `lock` 确保配置更新过程是线程安全的。
