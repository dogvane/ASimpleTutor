# 设置功能 API 文档

## 概述

设置功能提供 API 端点用于管理系统配置：
- LLM 配置（获取、更新、测试连接）
- TTS 配置（获取、更新）

Base URL: `/api/v1/settings`

---

## 1. 获取 LLM 配置

### 请求

```
GET /api/v1/settings/llm
```

### 响应

**成功（200 OK）**

```json
{
  "items": [
    {
      "apiKeyMasked": "sk-abc...xyz",
      "baseUrl": "https://api.openai.com/v1",
      "model": "gpt-4",
      "isValid": true,
      "lastTested": null
    }
  ]
}
```

**字段说明**

| 字段 | 类型 | 说明 |
|------|------|------|
| apiKeyMasked | string | 脱敏后的 API Key（格式：`sk-前7位...后4位`） |
| baseUrl | string | API 基础 URL |
| model | string | 模型名称 |
| isValid | boolean | 配置是否有效（基于 API Key 是否为空判断） |
| lastTested | string\|null | 最后测试时间（ISO 8601 格式），当前版本为 null |

**错误响应**

```json
{
  "error": {
    "code": "GET_SETTINGS_FAILED",
    "message": "获取配置失败"
  }
}
```

---

## 2. 更新 LLM 配置

### 请求

```
PUT /api/v1/settings/llm
Content-Type: application/json
```

**请求体**

```json
{
  "apiKey": "sk-your-api-key",
  "baseUrl": "https://api.openai.com/v1",
  "model": "gpt-4"
}
```

**字段说明**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| apiKey | string | 是 | API 密钥 |
| baseUrl | string | 是 | API 基础 URL，必须是有效的绝对 URL |
| model | string | 是 | 模型名称 |

### 响应

**成功（200 OK）**

```json
{
  "success": true,
  "message": "配置已保存并实时生效",
  "items": [
    {
      "apiKeyMasked": "sk-your...key",
      "baseUrl": "https://api.openai.com/v1",
      "model": "gpt-4",
      "isValid": true,
      "lastTested": null
    }
  ]
}
```

**错误响应**

参数验证失败（400 Bad Request）：

```json
{
  "error": {
    "code": "BAD_REQUEST",
    "message": "API Key 不能为空"
  }
}
```

可能的验证错误消息：
- `API Key 不能为空`
- `Base URL 不能为空`
- `Base URL 格式无效`
- `Model 不能为空`

其他错误（400 Bad Request）：

```json
{
  "error": {
    "code": "UPDATE_SETTINGS_FAILED",
    "message": "更新配置失败"
  }
}
```

**副作用**

- 配置会写入 `appsettings.user.json` 文件
- **LLM 服务会立即更新配置，后续调用自动使用新配置，无需重启应用**

---

## 3. 测试 LLM 连接

### 请求

```
POST /api/v1/settings/llm/test
Content-Type: application/json
```

**请求体**

```json
{
  "apiKey": "sk-your-api-key",
  "baseUrl": "https://api.openai.com/v1",
  "model": "gpt-4"
}
```

### 响应

**成功（200 OK）**

```json
{
  "success": true,
  "message": "连接成功",
  "items": [
    {
      "success": true,
      "message": "连接成功",
      "modelInfo": "你好！我是 AI 助手。",
      "responseTimeMs": 1234
    }
  ]
}
```

**字段说明**

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 测试是否成功 |
| message | string | 结果消息 |
| modelInfo | string\|null | LLM 响应的前 100 个字符 |
| responseTimeMs | number | 响应时间（毫秒） |

**失败（400 Bad Request）**

```json
{
  "error": {
    "code": "CONNECTION_FAILED",
    "message": "连接失败: API Key 无效"
  }
}
```

或

```json
{
  "error": {
    "code": "TEST_FAILED",
    "message": "连接测试失败"
  }
}
```

---

## 4. 获取 TTS 配置

### 请求

```
GET /api/v1/settings/tts
```

### 响应

**成功（200 OK）**

```json
{
  "items": [
    {
      "apiKeyMasked": "sk-abc...xyz",
      "baseUrl": "https://api.openai.com/v1",
      "voice": "alloy",
      "isValid": true
    }
  ]
}
```

**字段说明**

| 字段 | 类型 | 说明 |
|------|------|------|
| apiKeyMasked | string | 脱敏后的 API Key（格式：`sk-前7位...后4位`） |
| baseUrl | string | API 基础 URL |
| voice | string | 语音模型名称 |
| isValid | boolean | 配置是否有效（基于 API Key 是否为空判断） |

**错误响应**

```json
{
  "error": {
    "code": "GET_SETTINGS_FAILED",
    "message": "获取配置失败"
  }
}
```

---

## 5. 更新 TTS 配置

### 请求

```
PUT /api/v1/settings/tts
Content-Type: application/json
```

**请求体**

```json
{
  "apiKey": "sk-your-api-key",
  "baseUrl": "https://api.openai.com/v1",
  "voice": "alloy",
  "speed": 1.0
}
```

**字段说明**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| apiKey | string | 是 | API 密钥 |
| baseUrl | string | 是 | API 基础 URL，必须是有效的绝对 URL |
| voice | string | 是 | 语音模型名称（alloy、echo、fable、onyx、nova、shimmer 等） |
| speed | number | 是 | 语速（0.25-4.0，默认 1.0） |

### 响应

**成功（200 OK）**

```json
{
  "success": true,
  "message": "配置已保存并实时生效",
  "items": [
    {
      "apiKeyMasked": "sk-your...key",
      "baseUrl": "https://api.openai.com/v1",
      "voice": "alloy",
      "speed": 1.0,
      "isValid": true
    }
  ]
}
```

**错误响应**

参数验证失败（400 Bad Request）：

```json
{
  "error": {
    "code": "BAD_REQUEST",
    "message": "API Key 不能为空"
  }
}
```

可能的验证错误消息：
- `API Key 不能为空`
- `Base URL 不能为空`
- `Base URL 格式无效`
- `Voice 不能为空`
- `Speed 不能为空或超出范围（0.25-4.0）`

其他错误（400 Bad Request）：

```json
{
  "error": {
    "code": "UPDATE_SETTINGS_FAILED",
    "message": "更新配置失败"
  }
}
```

**副作用**

- 配置会写入 `appsettings.user.json` 文件

---

## 错误码说明

| 错误码 | HTTP 状态码 | 说明 |
|--------|------------|------|
| BAD_REQUEST | 400 | 请求参数验证失败 |
| GET_SETTINGS_FAILED | 400 | 获取配置失败 |
| UPDATE_SETTINGS_FAILED | 400 | 更新配置失败 |
| CONNECTION_FAILED | 400 | LLM 连接测试失败 |
| TEST_FAILED | 400 | 连接测试过程异常 |

---

## 使用示例

### cURL

**获取配置**
```bash
curl http://localhost:5202/api/v1/settings/llm
```

**更新配置**
```bash
curl -X PUT http://localhost:5202/api/v1/settings/llm \
  -H "Content-Type: application/json" \
  -d '{
    "apiKey": "sk-your-api-key",
    "baseUrl": "https://api.openai.com/v1",
    "model": "gpt-4"
  }'
```

**测试连接**
```bash
curl -X POST http://localhost:5202/api/v1/settings/llm/test \
  -H "Content-Type: application/json" \
  -d '{
    "apiKey": "sk-your-api-key",
    "baseUrl": "https://api.openai.com/v1",
    "model": "gpt-4"
  }'
```

### JavaScript

```javascript
// 获取配置
const settings = await fetch('/api/v1/settings/llm')
  .then(res => res.json())
  .then(data => data.items[0])

// 更新配置
await fetch('/api/v1/settings/llm', {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    apiKey: 'sk-your-api-key',
    baseUrl: 'https://api.openai.com/v1',
    model: 'gpt-4'
  })
})

// 测试连接
const testResult = await fetch('/api/v1/settings/llm/test', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    apiKey: 'sk-your-api-key',
    baseUrl: 'https://api.openai.com/v1',
    model: 'gpt-4'
  })
}).then(res => res.json())
```
