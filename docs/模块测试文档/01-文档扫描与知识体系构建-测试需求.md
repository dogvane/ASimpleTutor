# 文档扫描与知识体系构建 - 单元测试需求文档

## 1. 测试范围概述

本文档针对「文档扫描与知识体系构建」模块进行单元测试设计，涵盖以下子模块：

- 文件发现与过滤
- 文档解析与分段
- 知识点提取与体系构建
- 知识系统存储与加载
- 质量控制与验证

---

## 2. 基础测试数据

### 2.1 测试用 Markdown 文件集

#### 正常文件集（有效输入）

| 文件名 | 用途 | 预期内容特征 |
|--------|------|--------------|
| `chapter01_入门指南.md` | 主章节文件 | 包含多级标题（#~###）、段落、代码块、列表 |
| `chapter02_核心概念.md` | 概念解释章节 | 包含定义句式（"X 是…"）、术语解释 |
| `chapter03_操作步骤.md` | 步骤型章节 | 包含有序/无序列表、步骤说明 |
| `nested/sub_section.md` | 子目录文件 | 嵌套路径测试 |
| `nested/deep/deep_content.md` | 深层嵌套文件 | 深度递归测试 |

#### 边界文件集（异常/特殊输入）

| 文件名 | 用途 | 预期内容特征 |
|--------|------|--------------|
| `empty.md` | 空文件 | 无内容，仅包含空白行 |
| `only_headings.md` | 仅标题 | 只有 `# Title` 无正文 |
| `code_blocks.md` | 代码块测试 | 包含 \`\`\` 代码块和行内代码 |
| `special_chars_中文文件.md` | 特殊字符文件名 | 中文命名、特殊符号 |
| `very_long_title_heading.md` | 超长标题测试 | 标题超过60字符 |
| `_hidden_file.md` | 隐藏文件 | 以下划线开头 |
| `temp_backup.md~` | 临时文件 | 波浪号后缀 |
| `README.md` | 非教材文件 | 应被排除的辅助文档 |

### 2.2 测试配置数据

#### 有效 BookHub 配置

| 参数 | 类型 | 说明 |
|------|------|------|
| `bookHubId` | string | 书籍中心 ID，如 "book_001_test" |
| `basePath` | string | 书籍数据源的根路径，如 "g:\\test_data\\books\\main_book" |

---

## 3. 测试用例

### 3.1 文件发现与解析模块测试

#### TC-FD-001: MarkdownScanner 基础扫描

| 项目 | 内容 |
|------|------|
| 前置条件 | 目录包含5个 `.md` 文件 |
| 输入 | `MarkdownScanner.ScanAsync(basePath)` |
| 预期输出 | 精确发现5个文件，生成对应的 `Document` 对象列表 |
| 验证点 | 文件数量正确性、`Document` 对象结构完整性 |

#### TC-FD-002: MarkdownScanner 递归扫描

| 项目 | 内容 |
|------|------|
| 前置条件 | 目录包含子目录，子目录含 `.md` 文件 |
| 输入 | `MarkdownScanner.ScanAsync(basePath)` |
| 预期输出 | 包含所有层级中的 `.md` 文件，生成对应的 `Document` 对象列表 |
| 验证点 | 递归深度覆盖、`Document` 对象结构完整性 |

#### TC-FD-003: MarkdownScanner 空目录处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 指定空目录或仅含非 `.md` 文件 |
| 输入 | `MarkdownScanner.ScanAsync(basePath)` |
| 预期输出 | 返回空 `Document` 对象列表，无异常 |
| 验证点 | 空结果处理、鲁棒性 |

---

### 3.2 知识点提取模块测试

#### TC-KP-001: KnowledgeBuilder 知识点提取

| 项目 | 内容 |
|------|------|
| 前置条件 | 解析后的文档结构 |
| 输入 | `KnowledgeBuilder.ExtractKnowledgePointsAsync(documents, bookRootId)` |
| 预期输出 | 生成知识点列表，每个知识点包含必要字段（KpId、Title、Type、Importance、SnippetIds、ChapterPath） |
| 验证点 | 知识点数量合理性、字段完整性 |

#### TC-KP-002: KnowledgeBuilder 知识树构建

| 项目 | 内容 |
|------|------|
| 前置条件 | 生成的知识点列表 |
| 输入 | `KnowledgeBuilder.BuildKnowledgeTree(knowledgePoints)` |
| 预期输出 | 构建知识点的层级结构树 |
| 验证点 | 知识树结构正确性、层级关系准确性 |

---

### 3.3 知识系统存储模块测试

#### TC-KS-001: KnowledgeSystemStore 保存知识系统

| 项目 | 内容 |
|------|------|
| 前置条件 | 构建好的知识系统 |
| 输入 | `KnowledgeSystemStore.SaveAsync(knowledgeSystem, cancellationToken)` |
| 预期输出 | 知识系统成功保存到文件系统 |
| 验证点 | 文件创建成功、文件内容正确 |

#### TC-KS-002: KnowledgeSystemStore 加载知识系统

| 项目 | 内容 |
|------|------|
| 前置条件 | 已保存的知识系统 |
| 输入 | `KnowledgeSystemStore.LoadAsync(bookRootId, cancellationToken)` |
| 预期输出 | 成功加载知识系统，返回元组 `(KnowledgeSystem?, List<Document>?)` |
| 验证点 | 知识系统加载成功、数据完整性 |

---

### 3.4 集成测试用例

#### TC-INT-001: KnowledgeBuilder 完整构建流程

| 项目 | 内容 |
|------|------|
| 前置条件 | 配置正确、测试文件集就绪 |
| 输入 | `KnowledgeBuilder.BuildAsync(bookRootId, basePath, cancellationToken)` |
| 预期输出 | 生成完整的 KnowledgeSystem 对象并保存 |
| 验证点 | 端到端流程正确性、知识系统结构完整性 |

#### TC-INT-002: KnowledgeBuilder 异常处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 目录不存在或无权限访问 |
| 输入 | `KnowledgeBuilder.BuildAsync(bookRootId, invalidBasePath, cancellationToken)` |
| 预期输出 | 捕获异常并记录日志，返回合理的错误信息 |
| 验证点 | 异常处理正确性、日志记录完整性 |

---

## 4. 测试数据文件命名规范

所有测试用 Markdown 文件应统一放置于：

```
/test_data/
├── normal/                    # 正常输入文件
│   ├── chapter01_入门指南.md
│   ├── chapter02_核心概念.md
│   └── ...
├── edge_cases/                # 边界情况文件
│   ├── empty.md
│   ├── only_headings.md
│   └── very_long_title_heading.md
└── config/                    # 测试配置文件
    ├── valid_config.yaml
    └── empty_config.yaml
```

---

## 5. 测试执行优先级

| 优先级 | 测试类型 | 说明 |
|--------|----------|------|
| P0 | 核心路径测试 | TC-FD-001、TC-KP-001、TC-KS-001、TC-INT-001 |
| P1 | 边界条件测试 | TC-FD-003、TC-KP-002、TC-KS-002 |
| P2 | 异常处理测试 | TC-INT-002 |
