# 文档扫描与知识体系构建 - 单元测试需求文档

## 1. 测试范围概述

本文档针对「文档扫描与知识体系构建」模块进行单元测试设计，涵盖以下子模块：

- 文件发现与过滤
- 文档解析与分段
- 知识点提取与体系构建
- 质量控制与验证

---

## 2. 基础测试数据

### 2.1 测试用 Markdown 文件集

#### 正常文件集（有效输入）

| 文件名 | 用途 | 预期内容特征 |
|--------|------|--------------|
| `chapter01_入门指南.md` | 主章节文件 | 包含多级标题（#~###）、段落、代码块、列表 |
| `chapter02_核心概念.md` | 概念解释章节 | 包含定义句式（"X 是…"）、术语解释 |
| `chapter03_操作步骤.md` | 步骤型章节 | 包含有序/无序列表、步骤说明 |
| `nested/sub_section.md` | 子目录文件 | 嵌套路径测试 |
| `nested/deep/deep_content.md` | 深层嵌套文件 | 深度递归测试 |

#### 边界文件集（异常/特殊输入）

| 文件名 | 用途 | 预期内容特征 |
|--------|------|--------------|
| `empty.md` | 空文件 | 无内容，仅包含空白行 |
| `only_headings.md` | 仅标题 | 只有 `# Title` 无正文 |
| `code_blocks.md` | 代码块测试 | 包含 \`\`\` 代码块和行内代码 |
| `special_chars_中文文件.md` | 特殊字符文件名 | 中文命名、特殊符号 |
| `very_long_title_heading.md` | 超长标题测试 | 标题超过60字符 |
| `_hidden_file.md` | 隐藏文件 | 以下划线开头 |
| `temp_backup.md~` | 临时文件 | 波浪号后缀 |
| `README.md` | 非教材文件 | 应被排除的辅助文档 |

#### 参考书目目录文件集（应排除）

| 目录/文件 | 用途 |
|-----------|------|
| `references/` | 参考书目主目录 |
| `references/book01.md` | 参考书目文件1 |
| `references/sub/ref02.md` | 参考书目子目录文件 |
| `参考书目/` | 中文参考书目目录 |
| `bibliography/ref.md` | 变体命名参考目录 |

### 2.2 测试配置数据

#### 有效 BookRoot 配置

```yaml
book_root_id: "book_001"
root_path: "/test_data/books/main_book"
reference_dir_names:
  - "references"
  - "参考书目"
  - "bibliography"
exclude_globs:
  - "**/references/**"
  - "**/参考书目/**"
```

---

## 3. 测试用例

### 3.1 文件发现模块测试

#### TC-FD-001: 基础文件发现

| 项目 | 内容 |
|------|------|
| 前置条件 | 目录包含5个 `.md` 文件 |
| 输入 | 指定根目录路径 |
| 预期输出 | 精确发现5个文件，忽略隐藏文件和临时文件 |
| 验证点 | 文件数量正确性、路径正确性 |

#### TC-FD-002: 递归扫描子目录

| 项目 | 内容 |
|------|------|
| 前置条件 | 目录包含子目录，子目录含 `.md` 文件 |
| 输入 | 启用递归扫描 |
| 预期输出 | 包含所有层级中的 `.md` 文件 |
| 验证点 | 递归深度覆盖、文件路径完整性 |

#### TC-FD-003: 排除参考书目目录

| 项目 | 内容 |
|------|------|
| 前置条件 | 目录包含 `references/` 和 `参考书目/` 子目录 |
| 输入 | 配置文件声明排除规则 |
| 预期输出 | 两个参考目录下的文件均不被发现 |
| 验证点 | 排除规则生效、文件数量正确（排除后） |

#### TC-FD-004: 过滤隐藏文件和临时文件

| 项目 | 内容 |
|------|------|
| 前置条件 | 目录包含 `_hidden.md`、`temp.md~`、`*.bak` |
| 输入 | 标准过滤规则 |
| 预期输出 | 上述文件均不被返回 |
| 验证点 | 过滤规则全面性 |

#### TC-FD-005: 空目录处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 指定空目录或仅含非 `.md` 文件 |
| 输入 | 扫描请求 |
| 预期输出 | 返回空列表，无异常 |
| 验证点 | 空结果处理、鲁棒性 |

---

### 3.2 文档解析与分段模块测试

#### TC-DP-001: 多级标题解析

| 项目 | 内容 |
|------|------|
| 前置条件 | 文件包含 `#` 到 `######` 各级标题 |
| 输入 | Markdown 文件内容 |
| 预期输出 | 正确识别标题层级结构，生成标题树 |
| 验证点 | 层级映射正确性、标题文本完整性 |

#### TC-DP-002: 段落分隔识别

| 项目 | 内容 |
|------|------|
| 前置条件 | 文件包含多个空行分隔的段落 |
| 输入 | Markdown 文件内容 |
| 预期输出 | 每个段落独立，段落边界正确 |
| 验证点 | 段落数量、段落内容完整性 |

#### TC-DP-003: 代码块类型标注

| 项目 | 内容 |
|------|------|
| 前置条件 | 文件包含 \`\`\`python、\`\`\`json、\`\`\`bash 代码块 |
| 输入 | Markdown 文件内容 |
| 预期输出 | 代码块被正确识别并标注类型 |
| 验证点 | 代码块边界、类型标注正确性 |

#### TC-DP-004: 引用块处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 文件包含 `>` 开头的引用块 |
| 输入 | Markdown 文件内容 |
| 预期输出 | 引用块被识别并标注 |
| 验证点 | 引用块边界、内容完整性 |

#### TC-DP-005: 空文件处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 传入空文件或仅空白字符 |
| 输入 | Markdown 文件内容 |
| 预期输出 | 返回空 Document 对象或合理的空状态 |
| 验证点 | 空状态处理、异常防护 |

#### TC-DP-006: 原文位置追踪

| 项目 | 内容 |
|------|------|
| 前置条件 | 标准结构文档 |
| 输入 | Markdown 文件内容 |
| 预期输出 | 每个段落/代码块关联文件路径和行号范围 |
| 验证点 | 位置信息准确性、可追溯性 |

---

### 3.3 知识点提取模块测试

#### TC-KP-001: 知识点识别与生成

| 项目 | 内容 |
|------|------|
| 前置条件 | 解析后的文档结构 |
| 输入 | Agent 任务请求 |
| 预期输出 | 生成知识点列表，每个知识点包含必要字段 |
| 验证点 | 知识点数量合理性、字段完整性 |

#### TC-KP-002: 层级归属正确性

| 项目 | 内容 |
|------|------|
| 前置条件 | 多层级章节结构 |
| 输入 | 解析后的文档结构 |
| 预期输出 | 知识点正确归属到对应章节路径 |
| 验证点 | 章节路径准确性 |

#### TC-KP-003: 证据片段绑定

| 项目 | 内容 |
|------|------|
| 前置条件 | 包含概念定义的段落 |
| 输入 | Agent 任务请求 |
| 预期输出 | 每个知识点关联至少1个原文片段引用 |
| 验证点 | 绑定数量、引用位置正确性 |

#### TC-KP-004: 重要性排序

| 项目 | 内容 |
|------|------|
| 前置条件 | 混合出现在标题和段落中的概念 |
| 输入 | 解析后的文档结构 |
| 预期输出 | 知识点按重要性排序（标题出现 > 段落出现） |
| 验证点 | 排序逻辑正确性 |

#### TC-KP-005: 同义知识点去重

| 项目 | 内容 |
|------|------|
| 前置条件 | 同一概念在不同章节以不同表述出现 |
| 输入 | Agent 任务请求 |
| 预期输出 | 识别为同一知识点，合并证据片段 |
| 验证点 | 去重准确性、别名保留 |

#### TC-KP-006: 输出格式验证

| 项目 | 内容 |
|------|------|
| 前置条件 | 正常解析结果 |
| 输入 | Agent 任务请求 |
| 预期输出 | 返回结构化数据，包含 schema_version |
| 验证点 | 格式规范性、字段完整性 |

---

### 3.4 质量控制模块测试

#### TC-QC-001: 知识点质量门槛检查

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点列表 |
| 输入 | 质量检查请求 |
| 预期输出 | 无效知识点被标记或过滤 |
| 验证点 | 过滤规则生效 |

#### TC-QC-002: 超长标题检测

| 项目 | 内容 |
|------|------|
| 前置条件 | 标题超过60字符的知识点 |
| 输入 | 质量检查请求 |
| 预期输出 | 该知识点被标记或拒绝 |
| 验证点 | 长度限制生效 |

#### TC-QC-003: 无意义章节名过滤

| 项目 | 内容 |
|------|------|
| 前置条件 | 包含"概述"、"总结"等通用章节名 |
| 输入 | 质量检查请求 |
| 预期输出 | 此类章节名不作为独立知识点 |
| 验证点 | 过滤逻辑正确性 |

#### TC-QC-004: 证据片段缺失检测

| 项目 | 内容 |
|------|------|
| 前置条件 | 无证据片段的知识点 |
| 输入 | 质量检查请求 |
| 预期输出 | 该知识点被标记为低质量或不通过 |
| 验证点 | 证据要求生效 |

---

### 3.5 集成测试用例

#### TC-INT-001: 完整扫描流程

| 项目 | 内容 |
|------|------|
| 前置条件 | 配置正确、测试文件集就绪 |
| 输入 | 启动扫描请求 |
| 预期输出 | 生成完整的 KnowledgeSystem 对象 |
| 验证点 | 端到端流程正确性 |

#### TC-INT-002: 带排除规则的完整扫描

| 项目 | 内容 |
|------|------|
| 前置条件 | 包含正常文件和参考书目文件 |
| 输入 | 启动扫描请求（配置排除规则） |
| 预期输出 | KnowledgeSystem 不包含参考书目内容 |
| 验证点 | 排除规则端到端生效 |

#### TC-INT-003: 增量扫描（复用缓存）

| 项目 | 内容 |
|------|------|
| 前置条件 | 首次扫描完成，产生缓存 |
| 输入 | 相同文件再次扫描 |
| 预期输出 | 复用缓存，结果一致 |
| 验证点 | 缓存机制正确性 |

#### TC-INT-004: 文件变化检测

| 项目 | 内容 |
|------|------|
| 前置条件 | 首次扫描完成，修改某文件 |
| 输入 | 扫描请求（带 hash/mtime 比对） |
| 预期输出 | 仅重新处理变化的文件 |
| 验证点 | 变化检测与增量更新 |

---

## 4. 测试数据文件命名规范

所有测试用 Markdown 文件应统一放置于：

```
/test_data/
├── normal/                    # 正常输入文件
│   ├── chapter01_入门指南.md
│   ├── chapter02_核心概念.md
│   └── ...
├── edge_cases/                # 边界情况文件
│   ├── empty.md
│   ├── only_headings.md
│   └── very_long_title_heading.md
├── references/                # 应被排除的参考书目
│   ├── book01.md
│   └── sub/ref02.md
└── config/                    # 测试配置文件
    ├── valid_config.yaml
    └── empty_config.yaml
```

---

## 5. 测试执行优先级

| 优先级 | 测试类型 | 说明 |
|--------|----------|------|
| P0 | 核心路径测试 | TC-FD-001、TC-DP-001、TC-KP-001、TC-INT-001 |
| P1 | 边界条件测试 | TC-FD-003、TC-DP-005、TC-KP-006 |
| P2 | 质量控制测试 | TC-QC-001 ~ TC-QC-004 |
| P3 | 集成与优化测试 | TC-INT-002 ~ TC-INT-004 |
