# 学习内容生成模块 - 单元测试需求文档

## 1. 测试范围概述

本文档针对「学习内容生成」模块（幻灯片教学卡片）进行单元测试设计，涵盖以下子模块：

- 精要速览生成（定义、要点、误区）
- 层次化内容生成（L1/L2/L3）
- 幻灯片卡片生成
- 原文片段关联
- 降级策略处理

对应设计文档：`03-学习内容生成（幻灯片教学卡片）.md`

---

## 2. 基础测试数据

### 2.1 测试用知识点（KnowledgePoint）

#### 正常知识点

| 字段 | 值 | 用途 |
|------|-----|------|
| KpId | "kp_001" | 主测试知识点 |
| Title | "什么是 Markdown" | 知识点标题 |
| Type | "Concept" | 知识点类型 |
| Importance | 5 | 重要性评分 |
| SnippetIds | ["snippet_001", "snippet_002"] | 原文片段ID列表 |
| ChapterPath | ["第一章", "1.1 基础概念"] | 章节路径 |
| BookHubId | "book_001_test" | 书籍中心ID |

#### 边界知识点

| 字段 | 值 | 用途 |
|------|-----|------|
| 空 Title | "" | 空标题测试 |
| 空 SnippetIds | [] | 无原文片段测试 |
| 超长 Title | 超过100字符的标题 | 超长标题测试 |

### 2.2 测试用原文片段（SourceSnippet）

| 片段ID | 文件路径 | 开始行 | 结束行 | 内容摘要 |
|--------|----------|--------|--------|----------|
| snippet_001 | "g:\\test_data\\docs\\ch01.md" | 10 | 20 | Markdown 定义和基本语法 |
| snippet_002 | "g:\\test_data\\docs\\ch01.md" | 21 | 30 | 标题语法说明 |
| snippet_003 | "g:\\test_data\\docs\\ch02.md" | 5 | 15 | 列表语法说明 |

### 2.3 测试用 LearningPack 预期结构

```json
{
  "kpId": "kp_001",
  "summary": {
    "definition": "Markdown 是一种轻量级标记语言...",
    "keyPoints": ["要点1", "要点2", "要点3"],
    "pitfalls": ["误区1", "误区2"]
  },
  "levels": [
    {"level": 1, "title": "概览", "content": "..."},
    {"level": 2, "title": "详细", "content": "..."},
    {"level": 3, "title": "深入", "content": "..."}
  ],
  "slideCards": [
    {
      "slideId": "slide_001",
      "kpId": "kp_001",
      "type": "cover",
      "order": 0,
      "title": "什么是 Markdown",
      "htmlContent": "<h2>什么是 Markdown</h2><p>Markdown 是一种轻量级标记语言...</p>",
      "sourceReferences": [],
      "config": {
        "allowSkip": true,
        "requireComplete": false
      }
    }
  ],
  "snippetIds": ["snippet_001", "snippet_002"],
  "relatedKpIds": []
}
```

---

## 3. 测试用例

### 3.1 LearningGenerator 核心功能测试

#### TC-LG-001: 正常生成学习内容

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点关联有效的原文片段，知识系统已保存 |
| 输入 | `LearningGenerator.GenerateAsync(knowledgePoint, cancellationToken)` |
| 预期输出 | 生成完整的 LearningPack 对象，包含摘要、层次化内容和幻灯片卡片 |
| 验证点 | LearningPack 结构完整性、字段有效性 |

#### TC-LG-002: 原文片段长度不足降级

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点关联的原文片段长度不足100字符 |
| 输入 | `LearningGenerator.GenerateAsync(knowledgePoint, cancellationToken)` |
| 预期输出 | 使用降级策略生成简化版 LearningPack |
| 验证点 | 降级触发、降级内容质量 |

#### TC-LG-003: 无原文片段降级

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点无关联原文片段 |
| 输入 | `LearningGenerator.GenerateAsync(knowledgePoint, cancellationToken)` |
| 预期输出 | 使用降级策略生成简化版 LearningPack |
| 验证点 | 降级触发、降级内容质量 |

#### TC-LG-004: LLM 失败降级

| 项目 | 内容 |
|------|------|
| 前置条件 | LLM 服务不可用或返回错误 |
| 输入 | `LearningGenerator.GenerateAsync(knowledgePoint, cancellationToken)` |
| 预期输出 | 使用降级策略生成简化版 LearningPack |
| 验证点 | 降级触发、降级内容质量 |

---

### 3.2 幻灯片卡片生成测试

#### TC-LG-SLIDE-001: 生成幻灯片卡片

| 项目 | 内容 |
|------|------|
| 前置条件 | 正常知识点和原文片段 |
| 输入 | `LearningGenerator.GenerateAsync(knowledgePoint, cancellationToken)` |
| 预期输出 | LearningPack.SlideCards 包含至少1张卡片 |
| 验证点 | 卡片数量、类型多样性 |

#### TC-LG-SLIDE-002: 幻灯片卡片类型转换

| 项目 | 内容 |
|------|------|
| 前置条件 | 正常知识点和原文片段 |
| 输入 | `LearningGenerator.GenerateAsync(knowledgePoint, cancellationToken)` |
| 预期输出 | 幻灯片卡片类型正确转换为系统定义的类型 |
| 验证点 | 类型转换正确性 |

---

### 3.3 原文片段关联测试

#### TC-LG-SNP-001: 片段 ID 传递

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点关联多个原文片段 |
| 输入 | KnowledgePoint.SnippetIds = ["s1", "s2", "s3"] |
| 预期输出 | LearningPack.SnippetIds 包含所有 ID |
| 验证点 | ID 列表完整性 |

#### TC-LG-SNP-002: 空片段列表处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点无关联片段 |
| 输入 | KnowledgePoint.SnippetIds = [] |
| 预期输出 | LearningPack.SnippetIds 为空列表 |
| 验证点 | 空列表处理正确性 |

---

### 3.4 边界条件测试

#### TC-LG-EDGE-001: 空知识点处理

| 项目 | 内容 |
|------|------|
| 前置条件 | KnowledgePoint 为 null |
| 输入 | `LearningGenerator.GenerateAsync(null, cancellationToken)` |
| 预期输出 | 抛出 ArgumentNullException |
| 验证点 | 空值处理正确性 |

#### TC-LG-EDGE-002: 超长标题处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点 Title 超过100字符 |
| 输入 | `LearningGenerator.GenerateAsync(knowledgePoint, cancellationToken)` |
| 预期输出 | 正常生成，可能截断或保留 |
| 验证点 | 超长输入鲁棒性 |

#### TC-LG-EDGE-003: 特殊字符处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 原文内容包含特殊字符 |
| 输入 | `LearningGenerator.GenerateAsync(knowledgePoint, cancellationToken)` |
| 预期输出 | 正确处理，不崩溃 |
| 验证点 | 特殊字符处理能力 |

---

## 4. 测试数据文件命名规范

所有测试用数据文件应统一放置于：

```
/test_data/LearningGeneration/
├── kp_test_data/                      # 知识点测试数据
│   ├── normal_kp.json                 # 正常知识点
│   ├── empty_title_kp.json            # 空标题知识点
│   └── empty_snippets_kp.json         # 无片段知识点
├── snippet_test_data/                 # 原文片段测试数据
│   ├── basic_snippets.json            # 基础片段集
│   └── multi_doc_snippets.json        # 多文档片段集
├── expected_output/                   # 预期输出数据
│   └── expected_learning_pack.json    # 预期 LearningPack
└── test-data/                         # 知识系统存储目录
    └── book_001_test/                 # 测试书籍根目录
        └── knowledge-system.json      # 知识系统数据
```

---

## 5. 测试执行优先级

| 优先级 | 测试类型 | 说明 |
|--------|----------|------|
| P0 | 核心路径测试 | TC-LG-001, TC-LG-SLIDE-001, TC-LG-SNP-001 |
| P1 | 降级策略测试 | TC-LG-002, TC-LG-003, TC-LG-004 |
| P2 | 边界条件测试 | TC-LG-EDGE-001 ~ TC-LG-EDGE-003 |

---

## 6. 测试配置说明

### 6.1 KnowledgeSystemStore 配置

```csharp
// 创建 KnowledgeSystemStore 实例
var knowledgeSystemStoreLoggerMock = new Mock<ILogger<KnowledgeSystemStore>>();
var knowledgeSystemStore = new KnowledgeSystemStore(knowledgeSystemStoreLoggerMock.Object, "test-data");

// 预先保存知识系统数据
await knowledgeSystemStore.SaveAsync(knowledgeSystem, cancellationToken);
```

### 6.2 ILLMService Mock

```csharp
// 正常返回
_llmServiceMock
    .Setup(s => s.ChatJsonAsync<LearningContentDto>(It.IsAny<string>(), It.IsAny<string>(), It.IsAny<CancellationToken>()))
    .ReturnsAsync(validLearningContentDto);

// 抛出异常（测试降级）
_llmServiceMock
    .Setup(s => s.ChatJsonAsync<LearningContentDto>(It.IsAny<string>(), It.IsAny<string>(), It.IsAny<CancellationToken>()))
    .ThrowsAsync(new Exception("LLM Error"));
```

### 6.3 LearningGenerator 实例化

```csharp
var learningGenerator = new LearningGenerator(
    knowledgeSystemStore,
    _llmServiceMock.Object,
    _loggerMock.Object
);
```
