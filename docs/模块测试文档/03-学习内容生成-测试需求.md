# 学习内容生成模块 - 单元测试需求文档

## 1. 测试范围概述

本文档针对「学习内容生成」模块（精要速览-原文对照-层次化展开）进行单元测试设计，涵盖以下子模块：

- 精要速览生成（定义、要点、误区）
- 层次化内容生成（L1/L2/L3）
- 原文片段关联
- 降级策略处理

对应设计文档：`03-学习内容生成（精要速览-原文对照-层次化展开）.md`

---

## 2. 基础测试数据

### 2.1 测试用知识点（KnowledgePoint）

#### 正常知识点

| 字段 | 值 | 用途 |
|------|-----|------|
| kp_id | "kp_001" | 主测试知识点 |
| title | "什么是 Markdown" | 知识点标题 |
| chapter_path | ["第一章", "1.1 基础概念"] | 章节路径 |
| importance | 0.8f | 重要性评分 |
| snippet_ids | ["snippet_001", "snippet_002"] | 原文片段ID列表 |

#### 边界知识点

| 字段 | 值 | 用途 |
|------|-----|------|
| 空 title | "" | 空标题测试 |
| 空 snippet_ids | [] | 无原文片段测试 |
| 超长 title | 超过100字符的标题 | 超长标题测试 |

### 2.2 测试用原文片段（SourceSnippet）

| 片段ID | 文件路径 | 标题路径 | 内容摘要 |
|--------|----------|----------|----------|
| snippet_001 | "/docs/ch01.md" | ["第一章", "1.1"] | Markdown 定义和基本语法 |
| snippet_002 | "/docs/ch01.md" | ["第一章", "1.2"] | 标题语法说明 |
| snippet_003 | "/docs/ch02.md" | ["第二章", "2.1"] | 列表语法说明 |

### 2.3 测试用 LearningPack 预期结构

```json
{
  "kp_id": "kp_001",
  "summary": {
    "definition": "Markdown 是一种轻量级标记语言...",
    "key_points": ["要点1", "要点2", "要点3"],
    "pitfalls": ["误区1", "误区2"]
  },
  "levels": [
    {"level": 1, "title": "概览", "content": "..."},
    {"level": 2, "title": "详细", "content": "..."},
    {"level": 3, "title": "深入", "content": "..."}
  ],
  "snippet_ids": ["snippet_001", "snippet_002"],
  "related_kp_ids": []
}
```

---

## 3. 测试用例

### 3.1 精要速览生成测试（TC-LG-SUM）

#### TC-LG-SUM-001: 正常生成定义

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点关联有效的原文片段 |
| 输入 | KnowledgePoint + SourceSnippet 列表 |
| 预期输出 | Summary.definition 不为空，1-3句话 |
| 验证点 | 定义长度、语言规范性 |

#### TC-LG-SUM-002: 正常生成核心要点

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点关联有效的原文片段 |
| 输入 | KnowledgePoint + SourceSnippet 列表 |
| 预期输出 | Summary.key_points 包含 3-7 条 |
| 验证点 | 要点数量、相关性 |

#### TC-LG-SUM-003: 正常生成常见误区

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点关联有效的原文片段 |
| 输入 | KnowledgePoint + SourceSnippet 列表 |
| 预期输出 | Summary.pitfalls 包含 1-3 条 |
| 验证点 | 误区数量、内容合理性 |

#### TC-LG-SUM-004: 空原文片段处理

| 项目 | 内容 |
|------|------|
| 前置条件 | snippet_ids 为空列表 |
| 输入 | KnowledgePoint（无关联片段） |
| 预期输出 | 使用降级策略生成简单 Summary |
| 验证点 | 降级逻辑正确性 |

---

### 3.2 层次化内容生成测试（TC-LG-LVL）

#### TC-LG-LVL-001: 生成 L1 概览层

| 项目 | 内容 |
|------|------|
| 前置条件 | 正常知识点和原文片段 |
| 输入 | GenerateAsync 请求 |
| 预期输出 | Levels[0].level == 1，Title 为"概览" |
| 验证点 | L1 结构正确性 |

#### TC-LG-LVL-002: 生成 L2 详细层

| 项目 | 内容 |
|------|------|
| 前置条件 | 正常知识点和原文片段 |
| 输入 | GenerateAsync 请求 |
| 预期输出 | Levels 包含 level == 2 的项 |
| 验证点 | L2 内容丰富度 |

#### TC-LG-LVL-003: 生成 L3 深入层

| 项目 | 内容 |
|------|------|
| 前置条件 | 正常知识点和原文片段 |
| 输入 | GenerateAsync 请求 |
| 预期输出 | Levels 包含 level == 3 的项 |
| 验证点 | L3 深度和扩展性 |

#### TC-LG-LVL-004: 层次结构完整性

| 项目 | 内容 |
|------|------|
| 前置条件 | 正常知识点和原文片段 |
| 输入 | GenerateAsync 请求 |
| 预期输出 | Levels 包含 L1/L2/L3 三层，且按顺序排列 |
| 验证点 | 层级顺序、完整性 |

---

### 3.3 原文片段关联测试（TC-LG-SNP）

#### TC-LG-SNP-001: 片段 ID 传递

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点关联多个原文片段 |
| 输入 | KnowledgePoint.snippet_ids = ["s1", "s2", "s3"] |
| 预期输出 | LearningPack.snippet_ids 包含所有 ID |
| 验证点 | ID 列表完整性 |

#### TC-LG-SNP-002: 空片段列表处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点无关联片段 |
| 输入 | KnowledgePoint.snippet_ids = [] |
| 预期输出 | LearningPack.snippet_ids 为空列表 |
| 验证点 | 空列表处理正确性 |

#### TC-LG-SNP-003: 片段内容引用

| 项目 | 内容 |
|------|------|
| 前置条件 | 有效的原文片段内容 |
| 输入 | 包含真实内容的 SourceSnippet |
| 预期输出 | 生成内容引用原文信息 |
| 验证点 | 内容相关性 |

---

### 3.4 降级策略测试（TC-LG-FBK）

#### TC-LG-FBK-001: LLM 失败降级

| 项目 | 内容 |
|------|------|
| 前置条件 | LLM 服务不可用或返回错误 |
| 输入 | GenerateAsync 请求 |
| 预期输出 | 使用降级策略生成内容 |
| 验证点 | 降级触发、降级内容质量 |

#### TC-LG-FBK-002: 降级生成 L1 概览

| 项目 | 内容 |
|------|------|
| 前置条件 | LLM 调用失败 |
| 输入 | GenerateAsync 请求 |
| 预期输出 | Levels 包含 L1，内容为降级生成 |
| 验证点 | L1 降级内容合理性 |

#### TC-LG-FBK-003: 降级摘要提取

| 项目 | 内容 |
|------|------|
| 前置条件 | LLM 调用失败，有原文片段 |
| 输入 | GenerateAsync 请求 |
| 预期输出 | Summary 基于原文片段句子简单提取 |
| 验证点 | 句子提取逻辑 |

---

### 3.5 边界条件测试（TC-LG-EDGE）

#### TC-LG-EDGE-001: 空知识点处理

| 项目 | 内容 |
|------|------|
| 前置条件 | KnowledgePoint 为 null |
| 输入 | GenerateAsync(null, snippets) |
| 预期输出 | 抛出 ArgumentNullException 或返回空 LearningPack |
| 验证点 | 空值处理正确性 |

#### TC-LG-EDGE-002: 空原文列表处理

| 项目 | 内容 |
|------|------|
| 前置条件 | SourceSnippet 列表为空 |
| 输入 | GenerateAsync(kp, []) |
| 预期输出 | 使用降级策略 |
| 验证点 | 空列表降级处理 |

#### TC-LG-EDGE-003: 超长标题处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 知识点 title 超过100字符 |
| 输入 | GenerateAsync(超长标题 kp, snippets) |
| 预期输出 | 正常生成，可能截断或保留 |
| 验证点 | 超长输入鲁棒性 |

#### TC-LG-EDGE-004: 特殊字符处理

| 项目 | 内容 |
|------|------|
| 前置条件 | 原文内容包含特殊字符 |
| 输入 | 包含代码块、表格的 SourceSnippet |
| 预期输出 | 正确处理，不崩溃 |
| 验证点 | 特殊字符处理能力 |

---

### 3.6 数据模型测试（TC-LG-MOD）

#### TC-LG-MOD-001: LearningPack 序列化

| 项目 | 内容 |
|------|------|
| 前置条件 | 正常 LearningPack 对象 |
| 输入 | JsonConvert.SerializeObject(lp) |
| 预期输出 | 有效 JSON 字符串 |
| 验证点 | JSON 序列化正确性 |

#### TC-LG-MOD-002: Summary 结构完整性

| 项目 | 内容 |
|------|------|
| 前置条件 | 正常 Summary 对象 |
| 输入 | Summary 对象 |
| 预期输出 | 所有字段不为 null |
| 验证点 | 结构完整性 |

#### TC-LG-MOD-003: ContentLevel 层级验证

| 项目 | 内容 |
|------|------|
| 前置条件 | ContentLevel 列表 |
| 输入 | Levels |
| 预期输出 | Level 值在 1-3 范围内 |
| 验证点 | 层级值有效性 |

---

## 4. 测试数据文件命名规范

所有测试用数据文件应统一放置于：

```
/test_data/LearningGeneration/
├── kp_test_data/                      # 知识点测试数据
│   ├── normal_kp.json                 # 正常知识点
│   ├── empty_title_kp.json            # 空标题知识点
│   └── empty_snippets_kp.json         # 无片段知识点
├── snippet_test_data/                 # 原文片段测试数据
│   ├── basic_snippets.json            # 基础片段集
│   └── multi_doc_snippets.json        # 多文档片段集
└── expected_output/                   # 预期输出数据
    └── expected_learning_pack.json    # 预期 LearningPack
```

---

## 5. 测试执行优先级

| 优先级 | 测试类型 | 说明 |
|--------|----------|------|
| P0 | 核心路径测试 | TC-LG-SUM-001, TC-LG-LVL-001, TC-LG-SNP-001 |
| P1 | 降级策略测试 | TC-LG-FBK-001, TC-LG-FBK-002 |
| P2 | 边界条件测试 | TC-LG-EDGE-001 ~ TC-LG-EDGE-004 |
| P3 | 数据模型测试 | TC-LG-MOD-001 ~ TC-LG-MOD-003 |

---

## 6. Mock 配置说明

### 6.1 ILLMService Mock

```csharp
// 正常返回
_llmServiceMock
    .Setup(s => s.ChatJsonAsync<LearningPackResponse>(...))
    .ReturnsAsync(validLearningPackResponse);

// 抛出异常（测试降级）
_llmServiceMock
    .Setup(s => s.ChatJsonAsync<LearningPackResponse>(...))
    .ThrowsAsync(new Exception("LLM Error"));
```

### 6.2 ISourceTracker Mock

```csharp
// 返回正常片段
_sourceTrackerMock
    .Setup(s => s.GetSources(It.IsAny<string[]>()))
    .Returns(validSnippets);

// 返回空列表
_sourceTrackerMock
    .Setup(s => s.GetSources(It.IsAny<string[]>()))
    .Returns(new List<SourceSnippet>());
```
